<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard RH - WorkWell</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/app.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
      .indicator-card {
        transition: transform 0.2s;
      }
      .indicator-card:hover {
        transform: translateY(-5px);
      }
      .alert-badge {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }
    </style>
  </head>
  <body>
    <div class="min-vh-100 d-flex flex-column">
      <!-- Header -->
      <header class="bg-white shadow-sm">
        <div class="container py-3">
          <div class="d-flex justify-content-between align-items-center">
            <h1 class="h4 mb-0 fw-bold text-primary" id="tituloDashboard">
              WorkWell - Dashboard RH
            </h1>
            <div class="d-flex align-items-center gap-3">
              <span class="text-muted" id="userInfo"></span>
              <a href="/dashboard" class="btn btn-outline-secondary btn-sm"
                >Dashboard</a
              >
              <button class="btn btn-outline-danger btn-sm" id="btnLogout">
                Sair
              </button>
            </div>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="flex-grow-1 bg-light">
        <div class="container py-5">
          <!-- Alertas (apenas para RH) -->
          <div id="alertasContainer" class="mb-4" style="display: none"></div>

          <!-- Indicadores em Tempo Real (apenas para RH) -->
          <div class="row mb-4" id="secaoIndicadores" style="display: none">
            <div class="col-12">
              <h2 class="h4 fw-bold mb-4">Indicadores em Tempo Real</h2>
            </div>
          </div>

          <div class="row g-4 mb-5" id="cardsIndicadores" style="display: none">
            <div class="col-md-6 col-lg-3">
              <div class="card shadow-sm border-0 indicator-card">
                <div class="card-body">
                  <h6 class="text-muted mb-2">Nível Médio de Humor</h6>
                  <h3 class="mb-0" id="nivelHumor">-</h3>
                  <small class="text-muted">Escala 1-5</small>
                </div>
              </div>
            </div>
            <div class="col-md-6 col-lg-3">
              <div class="card shadow-sm border-0 indicator-card">
                <div class="card-body">
                  <h6 class="text-muted mb-2">Frequência Consultas</h6>
                  <h3 class="mb-0" id="frequenciaConsultas">-</h3>
                  <small class="text-muted">Total de consultas</small>
                </div>
              </div>
            </div>
            <div class="col-md-6 col-lg-3">
              <div class="card shadow-sm border-0 indicator-card">
                <div class="card-body">
                  <h6 class="text-muted mb-2">Aderência Atividades</h6>
                  <h3 class="mb-0" id="aderenciaAtividades">-</h3>
                  <small class="text-muted">Taxa de participação</small>
                </div>
              </div>
            </div>
            <div class="col-md-6 col-lg-3">
              <div class="card shadow-sm border-0 indicator-card">
                <div class="card-body">
                  <h6 class="text-muted mb-2">Setores com Estresse</h6>
                  <h3 class="mb-0" id="totalSetoresEstresse">-</h3>
                  <small class="text-muted">Setores identificados</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Setores com Maior Estresse (apenas para RH) -->
          <div class="row mb-4" id="secaoSetoresEstresse" style="display: none">
            <div class="col-12">
              <div class="card shadow-sm border-0">
                <div class="card-header bg-white">
                  <h5 class="mb-0">Setores com Maior Estresse</h5>
                </div>
                <div class="card-body">
                  <div id="setoresEstresseContainer"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Enquetes Rápidas -->
          <div class="row mb-4">
            <div class="col-12">
              <div
                class="d-flex justify-content-between align-items-center mb-3"
              >
                <h2 class="h4 fw-bold mb-0">Enquetes Rápidas</h2>
                <button
                  class="btn btn-primary"
                  id="btnCriarEnquete"
                  style="display: none"
                >
                  <strong>+ Nova Enquete</strong>
                </button>
              </div>
            </div>
          </div>

          <div class="row g-4 mb-5" id="enquetesContainer"></div>

          <!-- Atividades de Bem-Estar -->
          <div class="row mb-4">
            <div class="col-12">
              <div
                class="d-flex justify-content-between align-items-center mb-3"
              >
                <h2 class="h4 fw-bold mb-0">Atividades de Bem-Estar</h2>
                <button
                  class="btn btn-primary"
                  id="btnCriarAtividade"
                  style="display: none"
                >
                  <strong>+ Nova Atividade</strong>
                </button>
              </div>
            </div>
          </div>

          <div class="row g-4 mb-5" id="atividadesContainer"></div>

          <!-- Registros de Humor Detalhados (apenas para RH) -->
          <div class="row mb-4" id="secaoRegistrosHumor" style="display: none">
            <div class="col-12">
              <div class="card shadow-sm border-0">
                <div class="card-header bg-white">
                  <h5 class="mb-0">Registros de Humor Detalhados</h5>
                </div>
                <div class="card-body">
                  <div id="registrosHumorContainer"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- Footer -->
      <footer class="bg-white border-top py-4 mt-auto">
        <div class="container text-center text-muted small">
          <p class="mb-0">
            &copy; 2025 WorkWell. Todos os direitos reservados.
          </p>
        </div>
      </footer>
    </div>

    <!-- Modal Criar Enquete -->
    <div class="modal fade" id="modalCriarEnquete" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Criar Nova Enquete</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="formCriarEnquete">
              <div class="mb-3">
                <label class="form-label">Pergunta</label>
                <input
                  type="text"
                  class="form-control"
                  id="enquetePergunta"
                  required
                  placeholder="Ex: Você está bem hoje?"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Data de Término (opcional)</label>
                <input
                  type="datetime-local"
                  class="form-control"
                  id="enqueteDataFim"
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="button" class="btn btn-primary" id="btnSalvarEnquete">
              Criar Enquete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Criar Atividade -->
    <div class="modal fade" id="modalCriarAtividade" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Criar Nova Atividade</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="formCriarAtividade">
              <div class="mb-3">
                <label class="form-label">Tipo de Atividade</label>
                <select class="form-select" id="atividadeTipo" required>
                  <option value="">Selecione...</option>
                  <option value="ATIVIDADE_FISICA">Atividade Física</option>
                  <option value="HAPPY_HOUR">Happy Hour</option>
                  <option value="PALESTRA_BEM_ESTAR">
                    Palestra de Bem-Estar
                  </option>
                  <option value="MEDITACAO_GUIADA">Meditação Guiada</option>
                  <option value="INTERACAO_SOCIAL">
                    Interação Social (Coffee-break, Dinâmicas)
                  </option>
                  <option value="SESSAO_ANTI_BURNOUT">
                    Sessões Anti-Burnout
                  </option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Título</label>
                <input
                  type="text"
                  class="form-control"
                  id="atividadeTitulo"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Descrição</label>
                <textarea
                  class="form-control"
                  id="atividadeDescricao"
                  rows="3"
                ></textarea>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Data/Hora de Início</label>
                  <input
                    type="datetime-local"
                    class="form-control"
                    id="atividadeDataInicio"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label"
                    >Data/Hora de Término (opcional)</label
                  >
                  <input
                    type="datetime-local"
                    class="form-control"
                    id="atividadeDataFim"
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Local</label>
                <input type="text" class="form-control" id="atividadeLocal" />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="btnSalvarAtividade"
            >
              Criar Atividade
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Registrar Humor -->
    <div class="modal fade" id="modalRegistrarHumor" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Como você está se sentindo?</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="formRegistrarHumor">
              <div class="mb-3">
                <label class="form-label">Nível de Humor (1-5)</label>
                <div class="d-flex justify-content-between mb-2">
                  <span>Muito Ruim</span>
                  <span>Muito Bom</span>
                </div>
                <input
                  type="range"
                  class="form-range"
                  id="humorNivel"
                  min="1"
                  max="5"
                  value="3"
                  required
                />
                <div class="text-center mt-2">
                  <span class="badge bg-primary" id="humorNivelDisplay">3</span>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Setor (opcional)</label>
                <input
                  type="text"
                  class="form-control"
                  id="humorSetor"
                  placeholder="Ex: TI, Vendas, etc."
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Observações (opcional)</label>
                <textarea
                  class="form-control"
                  id="humorObservacoes"
                  rows="3"
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="button" class="btn btn-primary" id="btnSalvarHumor">
              Registrar
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      (async function () {
        const token = localStorage.getItem("token");
        let userRole = localStorage.getItem("userRole");

        if (!token) {
          window.location.href = "/login";
          return;
        }

        // Debug: verificar role
        console.log("UserRole do localStorage:", userRole);

        // Se não tiver role, tentar buscar do token ou da API
        if (!userRole) {
          try {
            const response = await fetch("/api/usuarios/me", {
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            });
            if (response.ok) {
              const usuario = await response.json();
              userRole = usuario.role;
              localStorage.setItem("userRole", userRole);
              console.log("UserRole obtido da API:", userRole);
            }
          } catch (error) {
            console.error("Erro ao buscar role:", error);
          }
        }

        // Verificar se o usuário tem permissão para acessar esta página
        if (userRole !== "RH" && userRole !== "FUNCIONARIO") {
          alert("Você não tem permissão para acessar esta página.");
          window.location.href = "/dashboard";
          return;
        }

        document.getElementById("userInfo").textContent = `Perfil: ${
          userRole || "Usuário"
        }`;

        // Função para mostrar elementos do RH
        function mostrarElementosRH() {
          const btnCriarEnquete = document.getElementById("btnCriarEnquete");
          const btnCriarAtividade =
            document.getElementById("btnCriarAtividade");

          if (btnCriarEnquete) {
            btnCriarEnquete.style.display = "block";
            console.log("Botão criar enquete exibido");
          } else {
            console.error("Botão btnCriarEnquete não encontrado!");
          }

          if (btnCriarAtividade) {
            btnCriarAtividade.style.display = "block";
            console.log("Botão criar atividade exibido");
          } else {
            console.error("Botão btnCriarAtividade não encontrado!");
          }

          const secaoIndicadores = document.getElementById("secaoIndicadores");
          const cardsIndicadores = document.getElementById("cardsIndicadores");
          const secaoSetoresEstresse = document.getElementById(
            "secaoSetoresEstresse"
          );
          const alertasContainer = document.getElementById("alertasContainer");
          const secaoRegistrosHumor = document.getElementById(
            "secaoRegistrosHumor"
          );

          if (secaoIndicadores) secaoIndicadores.style.display = "block";
          if (cardsIndicadores) cardsIndicadores.style.display = "block";
          if (secaoSetoresEstresse)
            secaoSetoresEstresse.style.display = "block";
          if (alertasContainer) alertasContainer.style.display = "block";
          if (secaoRegistrosHumor) secaoRegistrosHumor.style.display = "block";

          carregarRegistrosHumor();
        }

        // Mostrar botões e seções apenas para RH
        if (userRole === "RH") {
          console.log("UserRole é RH, mostrando elementos");
          mostrarElementosRH();
        } else if (userRole === "FUNCIONARIO") {
          document.getElementById("tituloDashboard").textContent =
            "WorkWell - Bem-Estar";
        } else {
          console.warn(
            "UserRole não reconhecido:",
            userRole,
            "Tipo:",
            typeof userRole
          );
        }

        document.getElementById("btnLogout").addEventListener("click", () => {
          localStorage.removeItem("token");
          localStorage.removeItem("userRole");
          window.location.href = "/login";
        });

        // Função para fazer requisições autenticadas
        async function apiRequest(url, options = {}) {
          const defaultOptions = {
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
          };
          const response = await fetch(url, { ...defaultOptions, ...options });
          if (response.status === 401) {
            localStorage.removeItem("token");
            localStorage.removeItem("userRole");
            window.location.href = "/login";
          }
          return response;
        }

        // Carregar Dashboard
        async function carregarDashboard() {
          if (userRole !== "RH") {
            return; // Apenas RH pode ver o dashboard completo
          }

          try {
            const response = await apiRequest("/api/dashboard-rh");
            const data = await response.json();

            // Atualizar indicadores
            document.getElementById("nivelHumor").textContent =
              data.nivelMedioHumor ? data.nivelMedioHumor.toFixed(1) : "N/A";
            document.getElementById("frequenciaConsultas").textContent =
              data.frequenciaConsultas || 0;
            document.getElementById("aderenciaAtividades").textContent =
              data.aderenciaAtividades
                ? (data.aderenciaAtividades * 100).toFixed(1) + "%"
                : "0%";
            document.getElementById("totalSetoresEstresse").textContent =
              data.setoresComEstresse ? data.setoresComEstresse.length : 0;

            // Renderizar setores com estresse
            renderizarSetoresEstresse(data.setoresComEstresse || []);

            // Renderizar alertas
            renderizarAlertas(data.alertas || []);
          } catch (error) {
            console.error("Erro ao carregar dashboard:", error);
          }
        }

        // Renderizar setores com estresse
        function renderizarSetoresEstresse(setores) {
          const container = document.getElementById("setoresEstresseContainer");
          if (setores.length === 0) {
            container.innerHTML =
              "<p class='text-muted'>Nenhum setor com estresse identificado.</p>";
            return;
          }

          const html = setores
            .map(
              (setor) => `
          <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
            <div>
              <strong>${setor.setor || "Sem setor"}</strong>
              <small class="text-muted d-block">${
                setor.totalRegistros
              } registro(s)</small>
            </div>
            <div class="text-end">
              <span class="badge ${
                setor.nivelMedioHumor < 2.5
                  ? "bg-danger"
                  : setor.nivelMedioHumor < 3.5
                  ? "bg-warning"
                  : "bg-success"
              }">
                ${setor.nivelMedioHumor.toFixed(1)}/5.0
              </span>
            </div>
          </div>
        `
            )
            .join("");
          container.innerHTML = html;
        }

        // Renderizar alertas
        function renderizarAlertas(alertas) {
          const container = document.getElementById("alertasContainer");
          if (alertas.length === 0) {
            container.innerHTML = "";
            return;
          }

          const html = alertas
            .map((alerta) => {
              const severityClass =
                {
                  ALTA: "danger",
                  MEDIA: "warning",
                  BAIXA: "info",
                }[alerta.severidade] || "info";

              return `
            <div class="alert alert-${severityClass} alert-dismissible fade show" role="alert">
              <strong>${alerta.tipo}:</strong> ${alerta.mensagem}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          `;
            })
            .join("");
          container.innerHTML = html;
        }

        // Carregar enquetes
        async function carregarEnquetes() {
          try {
            const response = await apiRequest("/api/dashboard-rh/enquetes");
            const enquetes = await response.json();
            renderizarEnquetes(enquetes);
          } catch (error) {
            console.error("Erro ao carregar enquetes:", error);
          }
        }

        // Renderizar enquetes
        function renderizarEnquetes(enquetes) {
          const container = document.getElementById("enquetesContainer");
          if (enquetes.length === 0) {
            container.innerHTML =
              "<div class='col-12'><p class='text-muted'>Nenhuma enquete ativa no momento.</p></div>";
            return;
          }

          const html = enquetes
            .map((enquete) => {
              const jaRespondeu = enquete.jaRespondeu;
              const taxaResposta = (enquete.taxaResposta * 100).toFixed(1);

              return `
            <div class="col-md-6 col-lg-4">
              <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                  <h6 class="card-title">${enquete.pergunta}</h6>
                  <p class="text-muted small mb-2">
                    ${
                      enquete.totalRespostas
                    } resposta(s) - ${taxaResposta}% de participação
                  </p>
                  ${
                    jaRespondeu
                      ? '<span class="badge bg-success mb-2">Você já respondeu</span>'
                      : '<button class="btn btn-primary btn-sm mb-2" onclick="responderEnquete(\'' +
                        enquete.id +
                        "')\">Responder</button>"
                  }
                  ${
                    enquete.estatisticas && enquete.estatisticas.length > 0
                      ? `
                    <div class="mt-2">
                      ${enquete.estatisticas
                        .map(
                          (e) => `
                        <small class="d-block">${e.resposta}: ${e.total}</small>
                      `
                        )
                        .join("")}
                    </div>
                  `
                      : ""
                  }
                </div>
              </div>
            </div>
          `;
            })
            .join("");
          container.innerHTML = html;
        }

        // Responder enquete
        async function responderEnquete(enqueteId) {
          const resposta = prompt(
            "Digite sua resposta (ex: SIM, NÃO, TALVEZ, ou um número):"
          );
          if (!resposta) return;

          try {
            const response = await apiRequest(
              "/api/dashboard-rh/enquetes/responder",
              {
                method: "POST",
                body: JSON.stringify({
                  enqueteId: enqueteId,
                  resposta: resposta,
                }),
              }
            );

            if (response.ok) {
              alert("Resposta registrada com sucesso!");
              carregarEnquetes();
            } else {
              const error = await response.json();
              alert(
                "Erro: " +
                  (error.message || "Não foi possível registrar a resposta")
              );
            }
          } catch (error) {
            console.error("Erro ao responder enquete:", error);
            alert("Erro ao registrar resposta");
          }
        }

        // Criar enquete
        document
          .getElementById("btnCriarEnquete")
          .addEventListener("click", () => {
            const modal = new bootstrap.Modal(
              document.getElementById("modalCriarEnquete")
            );
            modal.show();
          });

        document
          .getElementById("btnSalvarEnquete")
          .addEventListener("click", async () => {
            const pergunta = document.getElementById("enquetePergunta").value;
            const dataFim = document.getElementById("enqueteDataFim").value;

            if (!pergunta) {
              alert("Por favor, preencha a pergunta");
              return;
            }

            try {
              const body = {
                pergunta: pergunta,
                dataFim: dataFim ? new Date(dataFim).toISOString() : null,
              };

              const response = await apiRequest("/api/dashboard-rh/enquetes", {
                method: "POST",
                body: JSON.stringify(body),
              });

              if (response.ok) {
                alert("Enquete criada com sucesso!");
                bootstrap.Modal.getInstance(
                  document.getElementById("modalCriarEnquete")
                ).hide();
                document.getElementById("formCriarEnquete").reset();
                carregarEnquetes();
                if (userRole === "RH") {
                  carregarDashboard();
                }
              } else {
                const errorData = await response
                  .json()
                  .catch(() => ({ message: "Erro desconhecido" }));
                const errorMessage =
                  errorData.message ||
                  errorData.details?.[0] ||
                  "Não foi possível criar a enquete";
                alert("Erro: " + errorMessage);
                console.error("Erro ao criar enquete:", errorData);
              }
            } catch (error) {
              console.error("Erro ao criar enquete:", error);
              alert("Erro ao criar enquete: " + error.message);
            }
          });

        // Carregar atividades
        async function carregarAtividades() {
          try {
            const response = await apiRequest("/api/dashboard-rh/atividades");
            const atividades = await response.json();
            renderizarAtividades(atividades);
          } catch (error) {
            console.error("Erro ao carregar atividades:", error);
          }
        }

        // Renderizar atividades
        function renderizarAtividades(atividades) {
          const container = document.getElementById("atividadesContainer");
          if (atividades.length === 0) {
            container.innerHTML =
              "<div class='col-12'><p class='text-muted'>Nenhuma atividade cadastrada.</p></div>";
            return;
          }

          const tipoLabels = {
            ATIVIDADE_FISICA: "Atividade Física",
            HAPPY_HOUR: "Happy Hour",
            PALESTRA_BEM_ESTAR: "Palestra de Bem-Estar",
            MEDITACAO_GUIADA: "Meditação Guiada",
            INTERACAO_SOCIAL: "Interação Social",
            SESSAO_ANTI_BURNOUT: "Sessão Anti-Burnout",
          };

          const html = atividades
            .map((atividade) => {
              const jaParticipou = atividade.jaParticipou;
              const taxaParticipacao = (
                atividade.taxaParticipacao * 100
              ).toFixed(1);
              const dataInicio = new Date(
                atividade.dataHoraInicio
              ).toLocaleString("pt-BR");

              return `
            <div class="col-md-6 col-lg-4">
              <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                  <span class="badge bg-secondary mb-2">${
                    tipoLabels[atividade.tipo] || atividade.tipo
                  }</span>
                  <h6 class="card-title">${atividade.titulo}</h6>
                  ${
                    atividade.descricao
                      ? `<p class="text-muted small">${atividade.descricao}</p>`
                      : ""
                  }
                  <p class="small mb-2">
                    <strong>Data:</strong> ${dataInicio}<br>
                    ${
                      atividade.local
                        ? `<strong>Local:</strong> ${atividade.local}`
                        : ""
                    }
                  </p>
                  <p class="text-muted small mb-2">
                    ${
                      atividade.totalParticipantes
                    } participante(s) - ${taxaParticipacao}% de aderência
                  </p>
                  ${
                    userRole === "RH"
                      ? `<button class="btn btn-info btn-sm mb-2" onclick="verParticipantes('${
                          atividade.id
                        }')">Ver Participantes (${
                          atividade.totalParticipantes || 0
                        })</button><br>`
                      : ""
                  }
                  ${
                    jaParticipou
                      ? '<span class="badge bg-success">Você já está participando</span>'
                      : '<button class="btn btn-primary btn-sm" onclick="participarAtividade(\'' +
                        atividade.id +
                        "')\">Participar</button>"
                  }
                </div>
              </div>
            </div>
          `;
            })
            .join("");
          container.innerHTML = html;
        }

        // Participar atividade
        async function participarAtividade(atividadeId) {
          try {
            const response = await apiRequest(
              "/api/dashboard-rh/atividades/participar",
              {
                method: "POST",
                body: JSON.stringify({
                  atividadeId: atividadeId,
                }),
              }
            );

            if (response.ok) {
              alert("Participação registrada com sucesso!");
              carregarAtividades();
              if (userRole === "RH") {
                carregarDashboard();
              }
            } else {
              const error = await response.json();
              alert(
                "Erro: " +
                  (error.message || "Não foi possível registrar a participação")
              );
            }
          } catch (error) {
            console.error("Erro ao participar atividade:", error);
            alert("Erro ao registrar participação");
          }
        }

        // Criar atividade
        document
          .getElementById("btnCriarAtividade")
          .addEventListener("click", () => {
            const modal = new bootstrap.Modal(
              document.getElementById("modalCriarAtividade")
            );
            modal.show();
          });

        document
          .getElementById("btnSalvarAtividade")
          .addEventListener("click", async () => {
            const tipo = document.getElementById("atividadeTipo").value;
            const titulo = document.getElementById("atividadeTitulo").value;
            const descricao =
              document.getElementById("atividadeDescricao").value;
            const dataInicio = document.getElementById(
              "atividadeDataInicio"
            ).value;
            const dataFim = document.getElementById("atividadeDataFim").value;
            const local = document.getElementById("atividadeLocal").value;

            if (!tipo || !titulo || !dataInicio) {
              alert("Por favor, preencha os campos obrigatórios");
              return;
            }

            try {
              const body = {
                tipo: tipo,
                titulo: titulo,
                descricao: descricao || null,
                dataHoraInicio: new Date(dataInicio).toISOString(),
                dataHoraFim: dataFim ? new Date(dataFim).toISOString() : null,
                local: local || null,
              };

              const response = await apiRequest(
                "/api/dashboard-rh/atividades",
                {
                  method: "POST",
                  body: JSON.stringify(body),
                }
              );

              if (response.ok) {
                alert("Atividade criada com sucesso!");
                bootstrap.Modal.getInstance(
                  document.getElementById("modalCriarAtividade")
                ).hide();
                document.getElementById("formCriarAtividade").reset();
                carregarAtividades();
                if (userRole === "RH") {
                  carregarDashboard();
                }
              } else {
                const errorData = await response
                  .json()
                  .catch(() => ({ message: "Erro desconhecido" }));
                const errorMessage =
                  errorData.message ||
                  errorData.details?.[0] ||
                  "Não foi possível criar a atividade";
                alert("Erro: " + errorMessage);
                console.error("Erro ao criar atividade:", errorData);
              }
            } catch (error) {
              console.error("Erro ao criar atividade:", error);
              alert("Erro ao criar atividade: " + error.message);
            }
          });

        // Registrar humor
        document.getElementById("humorNivel").addEventListener("input", (e) => {
          document.getElementById("humorNivelDisplay").textContent =
            e.target.value;
        });

        document
          .getElementById("btnSalvarHumor")
          .addEventListener("click", async () => {
            const nivel = parseInt(document.getElementById("humorNivel").value);
            const setor = document.getElementById("humorSetor").value;
            const observacoes =
              document.getElementById("humorObservacoes").value;

            try {
              const response = await apiRequest("/api/dashboard-rh/humor", {
                method: "POST",
                body: JSON.stringify({
                  nivelHumor: nivel,
                  setor: setor || null,
                  observacoes: observacoes || null,
                }),
              });

              if (response.ok) {
                alert("Humor registrado com sucesso!");
                bootstrap.Modal.getInstance(
                  document.getElementById("modalRegistrarHumor")
                ).hide();
                document.getElementById("formRegistrarHumor").reset();
                document.getElementById("humorNivelDisplay").textContent = "3";
                if (userRole === "RH") {
                  carregarDashboard();
                  carregarRegistrosHumor();
                }
              } else {
                const error = await response.json();
                alert(
                  "Erro: " +
                    (error.message || "Não foi possível registrar o humor")
                );
              }
            } catch (error) {
              console.error("Erro ao registrar humor:", error);
              alert("Erro ao registrar humor");
            }
          });

        // Botão para registrar humor (visível para todos)
        const btnRegistrarHumor = document.createElement("button");
        btnRegistrarHumor.className = "btn btn-primary btn-sm";
        btnRegistrarHumor.textContent = "Registrar Humor";
        btnRegistrarHumor.onclick = () => {
          const modal = new bootstrap.Modal(
            document.getElementById("modalRegistrarHumor")
          );
          modal.show();
        };
        document.querySelector("header .d-flex").appendChild(btnRegistrarHumor);

        // Carregar registros de humor (apenas RH)
        async function carregarRegistrosHumor() {
          if (userRole !== "RH") return;

          try {
            const response = await apiRequest(
              "/api/dashboard-rh/humor/registros"
            );
            const registros = await response.json();
            renderizarRegistrosHumor(registros);
          } catch (error) {
            console.error("Erro ao carregar registros de humor:", error);
          }
        }

        // Renderizar registros de humor
        function renderizarRegistrosHumor(registros) {
          const container = document.getElementById("registrosHumorContainer");
          if (registros.length === 0) {
            container.innerHTML =
              "<p class='text-muted'>Nenhum registro de humor encontrado.</p>";
            return;
          }

          const html = registros
            .map((registro) => {
              const dataRegistro = new Date(registro.createdAt).toLocaleString(
                "pt-BR"
              );
              const nivelClass =
                registro.nivelHumor < 2.5
                  ? "danger"
                  : registro.nivelHumor < 3.5
                  ? "warning"
                  : "success";

              return `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
              <div>
                <strong>${registro.nomeUsuario}</strong>
                <small class="text-muted d-block">${dataRegistro}</small>
                ${
                  registro.setor
                    ? `<small class="text-muted">Setor: ${registro.setor}</small>`
                    : ""
                }
                ${
                  registro.observacoes
                    ? `<p class="small mb-0 mt-1">${registro.observacoes}</p>`
                    : ""
                }
              </div>
              <div class="text-end">
                <span class="badge bg-${nivelClass}">${
                registro.nivelHumor
              }/5</span>
              </div>
            </div>
          `;
            })
            .join("");
          container.innerHTML = html;
        }

        // Ver participantes de atividade
        async function verParticipantes(atividadeId) {
          try {
            const response = await apiRequest(
              `/api/dashboard-rh/atividades/${atividadeId}/participantes`
            );
            const participantes = await response.json();

            if (participantes.length === 0) {
              alert("Nenhum participante ainda.");
              return;
            }

            const lista = participantes
              .map((p) => `• ${p.nomeUsuario} (${p.emailUsuario})`)
              .join("\n");
            alert(`Participantes:\n\n${lista}`);
          } catch (error) {
            console.error("Erro ao carregar participantes:", error);
            alert("Erro ao carregar participantes");
          }
        }

        // Expor funções no escopo global para uso em onclick
        window.responderEnquete = responderEnquete;
        window.participarAtividade = participarAtividade;
        window.verParticipantes = verParticipantes;

        // Carregar dados iniciais
        if (userRole === "RH") {
          carregarDashboard();
        }
        // Sempre carregar enquetes e atividades para RH e FUNCIONARIO
        carregarEnquetes();
        carregarAtividades();

        // Atualizar a cada 30 segundos
        setInterval(() => {
          if (userRole === "RH") {
            carregarDashboard();
            carregarRegistrosHumor();
          }
          carregarEnquetes();
          carregarAtividades();
        }, 30000);
      })(); // Fechar função async auto-executável
    </script>
  </body>
</html>
