<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard RH - WorkWell</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/app.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
      .indicator-card {
        transition: transform 0.2s;
      }
      .indicator-card:hover {
        transform: translateY(-5px);
      }
      .alert-badge {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }
    </style>
  </head>
  <body>
    <div class="min-vh-100 d-flex flex-column">
      <!-- Header -->
      <header class="bg-white shadow-sm">
        <div class="container py-3">
          <div class="d-flex justify-content-between align-items-center">
            <h1 class="h4 mb-0 fw-bold text-primary" id="tituloDashboard">
              WorkWell - Dashboard RH
            </h1>
            <div class="d-flex align-items-center gap-3">
              <span class="text-muted" id="userInfo"></span>
              <a href="/dashboard" class="btn btn-outline-secondary btn-sm"
                >Dashboard</a
              >
              <button class="btn btn-outline-danger btn-sm" id="btnLogout">
                Sair
              </button>
            </div>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="flex-grow-1 bg-light">
        <div class="container py-5">
          <!-- Alertas (apenas para RH) -->
          <div id="alertasContainer" class="mb-4" style="display: none"></div>

          <!-- Indicadores em Tempo Real (apenas para RH) -->
          <div class="row mb-4" id="secaoIndicadores" style="display: none">
            <div class="col-12">
              <h2 class="h4 fw-bold mb-4">Indicadores em Tempo Real</h2>
            </div>
          </div>

          <div class="row g-4 mb-5" id="cardsIndicadores" style="display: none">
            <div class="col-md-6 col-lg-3">
              <div class="card shadow-sm border-0 indicator-card">
                <div class="card-body">
                  <h6 class="text-muted mb-2">N√≠vel M√©dio de Humor</h6>
                  <h3 class="mb-0" id="nivelHumor">-</h3>
                  <small class="text-muted">Escala 1-5</small>
                </div>
              </div>
            </div>
            <div class="col-md-6 col-lg-3">
              <div class="card shadow-sm border-0 indicator-card">
                <div class="card-body">
                  <h6 class="text-muted mb-2">Frequ√™ncia Consultas</h6>
                  <h3 class="mb-0" id="frequenciaConsultas">-</h3>
                  <small class="text-muted">Total de consultas</small>
                </div>
              </div>
            </div>
            <div class="col-md-6 col-lg-3">
              <div class="card shadow-sm border-0 indicator-card">
                <div class="card-body">
                  <h6 class="text-muted mb-2">Ader√™ncia Atividades</h6>
                  <h3 class="mb-0" id="aderenciaAtividades">-</h3>
                  <small class="text-muted">Taxa de participa√ß√£o</small>
                </div>
              </div>
            </div>
            <div class="col-md-6 col-lg-3">
              <div class="card shadow-sm border-0 indicator-card">
                <div class="card-body">
                  <h6 class="text-muted mb-2">Setores com Estresse</h6>
                  <h3 class="mb-0" id="totalSetoresEstresse">-</h3>
                  <small class="text-muted">Setores identificados</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Setores com Maior Estresse (apenas para RH) -->
          <div class="row mb-4" id="secaoSetoresEstresse" style="display: none">
            <div class="col-12">
              <div class="card shadow-sm border-0">
                <div class="card-header bg-white">
                  <h5 class="mb-0">Setores com Maior Estresse</h5>
                </div>
                <div class="card-body">
                  <div id="setoresEstresseContainer"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Se√ß√£o de Intelig√™ncia Artificial -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom">
                  <h5 class="mb-0 fw-bold">
                    ü§ñ Assistente de IA - WorkWell
                    <span class="badge bg-primary ms-2">Beta</span>
                  </h5>
                </div>
                <div class="card-body">
                  <div class="row g-4">
                    <!-- Chat Assistente -->
                    <div class="col-md-6 col-lg-4">
                      <div class="card h-100 border-primary">
                        <div class="card-body">
                          <h6 class="card-title fw-bold">üí¨ Chat Assistente</h6>
                          <p class="card-text text-muted small">
                            Converse com nosso assistente virtual sobre
                            bem-estar, sa√∫de mental e quest√µes do trabalho.
                          </p>
                          <button
                            class="btn btn-primary btn-sm w-100"
                            onclick="abrirChatIA()"
                          >
                            Abrir Chat
                          </button>
                        </div>
                      </div>
                    </div>

                    <!-- An√°lise de Sentimentos -->
                    <div class="col-md-6 col-lg-4">
                      <div class="card h-100 border-info">
                        <div class="card-body">
                          <h6 class="card-title fw-bold">
                            üìä An√°lise de Sentimentos
                          </h6>
                          <p class="card-text text-muted small">
                            Analise os registros de humor e obtenha insights
                            sobre o bem-estar emocional da equipe.
                          </p>
                          <button
                            class="btn btn-info btn-sm w-100"
                            onclick="abrirAnaliseSentimento()"
                          >
                            Analisar Sentimentos
                          </button>
                        </div>
                      </div>
                    </div>

                    <!-- Insights RH -->
                    <div class="col-md-6 col-lg-4">
                      <div class="card h-100 border-warning">
                        <div class="card-body">
                          <h6 class="card-title fw-bold">
                            üìà Insights Estrat√©gicos
                          </h6>
                          <p class="card-text text-muted small">
                            Obtenha insights estrat√©gicos baseados nos dados do
                            dashboard para tomada de decis√£o.
                          </p>
                          <button
                            class="btn btn-warning btn-sm w-100"
                            onclick="abrirInsightsRH()"
                          >
                            Gerar Insights
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Enquetes R√°pidas -->
          <div class="row mb-4">
            <div class="col-12">
              <div
                class="d-flex justify-content-between align-items-center mb-3"
              >
                <h2 class="h4 fw-bold mb-0">Enquetes R√°pidas</h2>
                <button
                  class="btn btn-primary"
                  id="btnCriarEnquete"
                  style="display: none"
                >
                  <strong>+ Nova Enquete</strong>
                </button>
              </div>
            </div>
          </div>

          <div class="row g-4 mb-5" id="enquetesContainer"></div>

          <!-- Atividades de Bem-Estar -->
          <div class="row mb-4">
            <div class="col-12">
              <div
                class="d-flex justify-content-between align-items-center mb-3"
              >
                <h2 class="h4 fw-bold mb-0">Atividades de Bem-Estar</h2>
                <button
                  class="btn btn-primary"
                  id="btnCriarAtividade"
                  style="display: none"
                >
                  <strong>+ Nova Atividade</strong>
                </button>
              </div>
            </div>
          </div>

          <div class="row g-4 mb-5" id="atividadesContainer"></div>

          <!-- Avalia√ß√µes Profundas (NR-1) -->
          <div class="row mb-4" id="secaoAvaliacoesProfundas">
            <div class="col-12">
              <div
                class="d-flex justify-content-between align-items-center mb-3"
              >
                <h2 class="h4 fw-bold mb-0">Avalia√ß√µes Profundas (NR-1)</h2>
                <button
                  class="btn btn-primary"
                  id="btnCriarAvaliacaoProfunda"
                  style="display: none"
                >
                  <strong>+ Nova Avalia√ß√£o</strong>
                </button>
              </div>
              <p class="text-muted small mb-3">
                Avalia√ß√µes semanais criadas por psic√≥logos para monitoramento de
                sa√∫de ocupacional conforme NR-1. Relat√≥rios confidenciais
                dispon√≠veis apenas para psic√≥logos.
              </p>
            </div>
          </div>

          <div class="row g-4 mb-5" id="avaliacoesProfundasContainer"></div>

          <!-- Minhas Avalia√ß√µes (apenas para PSICOLOGO) -->
          <div
            class="row mb-4"
            id="secaoMinhasAvaliacoes"
            style="display: none"
          >
            <div class="col-12">
              <h2 class="h4 fw-bold mb-3">Minhas Avalia√ß√µes Criadas</h2>
              <div class="row g-4 mb-5" id="minhasAvaliacoesContainer"></div>
            </div>
          </div>

          <!-- Registros de Humor Detalhados (apenas para RH) -->
          <div class="row mb-4" id="secaoRegistrosHumor" style="display: none">
            <div class="col-12">
              <div class="card shadow-sm border-0">
                <div class="card-header bg-white">
                  <h5 class="mb-0">Registros de Humor Detalhados</h5>
                </div>
                <div class="card-body">
                  <div id="registrosHumorContainer"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- Footer -->
      <footer class="bg-white border-top py-4 mt-auto">
        <div class="container text-center text-muted small">
          <p class="mb-0">
            &copy; 2025 WorkWell. Todos os direitos reservados.
          </p>
        </div>
      </footer>
    </div>

    <!-- Modal Criar Enquete -->
    <div class="modal fade" id="modalCriarEnquete" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Criar Nova Enquete</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="formCriarEnquete">
              <div class="mb-3">
                <label class="form-label">Pergunta</label>
                <input
                  type="text"
                  class="form-control"
                  id="enquetePergunta"
                  required
                  placeholder="Ex: O que voc√™s acharam da nova campanha?"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Op√ß√µes de Resposta</label>
                <div id="opcoesContainer">
                  <div class="input-group mb-2">
                    <input
                      type="text"
                      class="form-control opcao-input"
                      placeholder="Ex: BOM"
                    />
                    <button
                      type="button"
                      class="btn btn-outline-danger"
                      onclick="removerOpcao(this)"
                    >
                      Remover
                    </button>
                  </div>
                  <div class="input-group mb-2">
                    <input
                      type="text"
                      class="form-control opcao-input"
                      placeholder="Ex: RUIM"
                    />
                    <button
                      type="button"
                      class="btn btn-outline-danger"
                      onclick="removerOpcao(this)"
                    >
                      Remover
                    </button>
                  </div>
                  <div class="input-group mb-2">
                    <input
                      type="text"
                      class="form-control opcao-input"
                      placeholder="Ex: N√ÉO VI AINDA"
                    />
                    <button
                      type="button"
                      class="btn btn-outline-danger"
                      onclick="removerOpcao(this)"
                    >
                      Remover
                    </button>
                  </div>
                </div>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary"
                  onclick="adicionarOpcao()"
                >
                  + Adicionar Op√ß√£o
                </button>
                <small class="form-text text-muted d-block mt-2">
                  Adicione pelo menos 2 op√ß√µes de resposta. Ex: SIM, N√ÉO, TALVEZ
                  ou BOM, RUIM, N√ÉO VI AINDA
                </small>
              </div>
              <div class="mb-3">
                <label class="form-label">Data de T√©rmino (opcional)</label>
                <input
                  type="datetime-local"
                  class="form-control"
                  id="enqueteDataFim"
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="button" class="btn btn-primary" id="btnSalvarEnquete">
              Criar Enquete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Responder Enquete -->
    <div class="modal fade" id="modalResponderEnquete" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalResponderEnqueteTitulo">
              Responder Enquete
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="formResponderEnquete">
              <div class="mb-3">
                <p class="fw-bold" id="modalResponderEnquetePergunta"></p>
              </div>
              <div class="mb-3">
                <label class="form-label">Sua Resposta</label>
                <div id="opcoesRespostaContainer"></div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="btnSalvarRespostaEnquete"
            >
              Responder
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Criar Atividade -->
    <div class="modal fade" id="modalCriarAtividade" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Criar Nova Atividade</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="formCriarAtividade">
              <div class="mb-3">
                <label class="form-label">Tipo de Atividade</label>
                <select class="form-select" id="atividadeTipo" required>
                  <option value="">Selecione...</option>
                  <option value="ATIVIDADE_FISICA">Atividade F√≠sica</option>
                  <option value="HAPPY_HOUR">Happy Hour</option>
                  <option value="PALESTRA_BEM_ESTAR">
                    Palestra de Bem-Estar
                  </option>
                  <option value="MEDITACAO_GUIADA">Medita√ß√£o Guiada</option>
                  <option value="INTERACAO_SOCIAL">
                    Intera√ß√£o Social (Coffee-break, Din√¢micas)
                  </option>
                  <option value="SESSAO_ANTI_BURNOUT">
                    Sess√µes Anti-Burnout
                  </option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">T√≠tulo</label>
                <input
                  type="text"
                  class="form-control"
                  id="atividadeTitulo"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Descri√ß√£o</label>
                <textarea
                  class="form-control"
                  id="atividadeDescricao"
                  rows="3"
                ></textarea>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Data/Hora de In√≠cio</label>
                  <input
                    type="datetime-local"
                    class="form-control"
                    id="atividadeDataInicio"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label"
                    >Data/Hora de T√©rmino (opcional)</label
                  >
                  <input
                    type="datetime-local"
                    class="form-control"
                    id="atividadeDataFim"
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Local</label>
                <input type="text" class="form-control" id="atividadeLocal" />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="btnSalvarAtividade"
            >
              Criar Atividade
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Criar Avalia√ß√£o Profunda -->
    <div class="modal fade" id="modalCriarAvaliacaoProfunda" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Criar Nova Avalia√ß√£o Profunda (NR-1)</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="formCriarAvaliacaoProfunda">
              <div class="mb-3">
                <label class="form-label">T√≠tulo da Avalia√ß√£o</label>
                <input
                  type="text"
                  class="form-control"
                  id="avaliacaoTitulo"
                  required
                  placeholder="Ex: Avalia√ß√£o Semanal de Bem-Estar - Semana 1"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Descri√ß√£o</label>
                <textarea
                  class="form-control"
                  id="avaliacaoDescricao"
                  rows="3"
                  placeholder="Descreva o objetivo desta avalia√ß√£o..."
                ></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Perguntas</label>
                <div id="perguntasContainer">
                  <div class="card mb-3 pergunta-item">
                    <div class="card-body">
                      <div class="row mb-2">
                        <div class="col-md-8">
                          <input
                            type="text"
                            class="form-control pergunta-texto"
                            placeholder="Digite a pergunta..."
                            required
                          />
                        </div>
                        <div class="col-md-4">
                          <select class="form-select pergunta-tipo" required>
                            <option value="TEXTO">Texto Livre</option>
                            <option value="NUMERICO">Num√©rico (1-10)</option>
                            <option value="ESCOLHA">Escolha √önica</option>
                          </select>
                        </div>
                      </div>
                      <div class="opcoes-escolha" style="display: none">
                        <label class="form-label small"
                          >Op√ß√µes de Resposta</label
                        >
                        <div class="opcoes-container">
                          <div class="input-group mb-2">
                            <input
                              type="text"
                              class="form-control opcao-input"
                              placeholder="Op√ß√£o 1"
                            />
                            <button
                              type="button"
                              class="btn btn-outline-danger btn-sm"
                              onclick="removerOpcaoEscolha(this)"
                            >
                              Remover
                            </button>
                          </div>
                        </div>
                        <button
                          type="button"
                          class="btn btn-sm btn-outline-primary"
                          onclick="adicionarOpcaoEscolha(this)"
                        >
                          + Adicionar Op√ß√£o
                        </button>
                      </div>
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-danger mt-2"
                        onclick="removerPergunta(this)"
                      >
                        Remover Pergunta
                      </button>
                    </div>
                  </div>
                </div>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary"
                  onclick="adicionarPergunta()"
                >
                  + Adicionar Pergunta
                </button>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Data/Hora de In√≠cio</label>
                  <input
                    type="datetime-local"
                    class="form-control"
                    id="avaliacaoDataInicio"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Data/Hora de T√©rmino</label>
                  <input
                    type="datetime-local"
                    class="form-control"
                    id="avaliacaoDataFim"
                    required
                  />
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="btnSalvarAvaliacaoProfunda"
            >
              Criar Avalia√ß√£o
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Responder Avalia√ß√£o Profunda -->
    <div class="modal fade" id="modalResponderAvaliacaoProfunda" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalResponderAvaliacaoTitulo">
              Responder Avalia√ß√£o Profunda
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="formResponderAvaliacaoProfunda">
              <div class="mb-3">
                <p class="text-muted" id="modalResponderAvaliacaoDescricao"></p>
              </div>
              <div id="respostasContainer"></div>
              <div class="mb-3">
                <label class="form-label"
                  >Observa√ß√µes Adicionais (opcional)</label
                >
                <textarea
                  class="form-control"
                  id="avaliacaoObservacoes"
                  rows="3"
                  placeholder="Adicione qualquer observa√ß√£o adicional..."
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="btnSalvarRespostaAvaliacaoProfunda"
            >
              Enviar Respostas
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Ver Relat√≥rio -->
    <div class="modal fade" id="modalVerRelatorio" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalRelatorioTitulo">
              Relat√≥rio Confidencial
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div id="relatorioContainer"></div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Fechar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Registrar Humor -->
    <div class="modal fade" id="modalRegistrarHumor" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Como voc√™ est√° se sentindo?</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="formRegistrarHumor">
              <div class="mb-3">
                <label class="form-label">N√≠vel de Humor (1-5)</label>
                <div class="d-flex justify-content-between mb-2">
                  <span>Muito Ruim</span>
                  <span>Muito Bom</span>
                </div>
                <input
                  type="range"
                  class="form-range"
                  id="humorNivel"
                  min="1"
                  max="5"
                  value="3"
                  required
                />
                <div class="text-center mt-2">
                  <span class="badge bg-primary" id="humorNivelDisplay">3</span>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Setor (opcional)</label>
                <input
                  type="text"
                  class="form-control"
                  id="humorSetor"
                  placeholder="Ex: TI, Vendas, etc."
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Observa√ß√µes (opcional)</label>
                <textarea
                  class="form-control"
                  id="humorObservacoes"
                  rows="3"
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="button" class="btn btn-primary" id="btnSalvarHumor">
              Registrar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modais de IA -->
    <!-- Modal Chat IA -->
    <div class="modal fade" id="modalChatIA" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">üí¨ Chat Assistente - WorkWell</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body" style="height: 400px; overflow-y: auto">
            <div id="chatMessages" class="mb-3">
              <div class="alert alert-info">
                <strong>Assistente:</strong> Ol√°! Sou o assistente virtual do
                WorkWell. Como posso ajud√°-lo hoje com quest√µes de bem-estar,
                sa√∫de mental ou trabalho?
              </div>
            </div>
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                id="chatInput"
                placeholder="Digite sua mensagem..."
              />
              <button class="btn btn-primary" onclick="enviarMensagemChat()">
                Enviar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal An√°lise de Sentimentos -->
    <div class="modal fade" id="modalAnaliseSentimento" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-info text-white">
            <h5 class="modal-title">üìä An√°lise de Sentimentos</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="formAnaliseSentimento">
              <div class="mb-3">
                <label class="form-label">Texto/Observa√ß√µes</label>
                <textarea
                  class="form-control"
                  id="analiseTexto"
                  rows="4"
                  placeholder="Descreva como voc√™ est√° se sentindo ou suas observa√ß√µes..."
                ></textarea>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">N√≠vel de Humor (1-10)</label>
                  <input
                    type="number"
                    class="form-control"
                    id="analiseNivelHumor"
                    min="1"
                    max="10"
                    placeholder="1-10"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Setor</label>
                  <input
                    type="text"
                    class="form-control"
                    id="analiseSetor"
                    placeholder="Seu setor"
                  />
                </div>
              </div>
              <button
                type="button"
                class="btn btn-info w-100"
                onclick="processarAnaliseSentimento()"
              >
                Analisar Sentimentos
              </button>
            </form>
            <div id="resultadoAnalise" class="mt-4" style="display: none">
              <hr />
              <h6 class="fw-bold">Resultado da An√°lise:</h6>
              <div id="analiseConteudo"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Insights RH -->
    <div class="modal fade" id="modalInsightsRH" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title">üìà Insights Estrat√©gicos - RH</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="text-center mb-4">
              <div
                class="spinner-border text-warning"
                role="status"
                id="insightsSpinner"
              >
                <span class="visually-hidden">Carregando...</span>
              </div>
              <p class="mt-2">
                Gerando insights estrat√©gicos baseados nos dados do dashboard...
              </p>
            </div>
            <div id="resultadoInsights" style="display: none">
              <div id="insightsConteudo"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Fechar
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      (async function () {
        try {
          console.log("Iniciando dashboard RH...");
          const token = localStorage.getItem("token");
          let userRole = localStorage.getItem("userRole");

          if (!token) {
            window.location.href = "/login";
            return;
          }

          // Debug: verificar role
          console.log("UserRole do localStorage:", userRole);

          // Se n√£o tiver role, tentar buscar do token ou da API
          if (!userRole) {
            try {
              const response = await fetch("/api/usuarios/me", {
                headers: {
                  Authorization: `Bearer ${token}`,
                  "Content-Type": "application/json",
                },
              });
              if (response.ok) {
                const usuario = await response.json();
                userRole = usuario.role;
                localStorage.setItem("userRole", userRole);
                console.log("UserRole obtido da API:", userRole);
              }
            } catch (error) {
              console.error("Erro ao buscar role:", error);
            }
          }

          // Verificar se o usu√°rio tem permiss√£o para acessar esta p√°gina
          if (userRole !== "RH" && userRole !== "FUNCIONARIO") {
            alert("Voc√™ n√£o tem permiss√£o para acessar esta p√°gina.");
            window.location.href = "/dashboard";
            return;
          }

          const userInfo = document.getElementById("userInfo");
          if (userInfo) {
            userInfo.textContent = `Perfil: ${userRole || "Usu√°rio"}`;
          }

          // Fun√ß√£o para mostrar elementos do RH
          function mostrarElementosRH() {
            const btnCriarEnquete = document.getElementById("btnCriarEnquete");
            const btnCriarAtividade =
              document.getElementById("btnCriarAtividade");

            if (btnCriarEnquete) {
              btnCriarEnquete.style.display = "block";
              console.log("Bot√£o criar enquete exibido");
            } else {
              console.error("Bot√£o btnCriarEnquete n√£o encontrado!");
            }

            if (btnCriarAtividade) {
              btnCriarAtividade.style.display = "block";
              console.log("Bot√£o criar atividade exibido");
            } else {
              console.error("Bot√£o btnCriarAtividade n√£o encontrado!");
            }

            const secaoIndicadores =
              document.getElementById("secaoIndicadores");
            const cardsIndicadores =
              document.getElementById("cardsIndicadores");
            const secaoSetoresEstresse = document.getElementById(
              "secaoSetoresEstresse"
            );
            const alertasContainer =
              document.getElementById("alertasContainer");
            const secaoRegistrosHumor = document.getElementById(
              "secaoRegistrosHumor"
            );

            if (secaoIndicadores) secaoIndicadores.style.display = "block";
            if (cardsIndicadores) cardsIndicadores.style.display = "block";
            if (secaoSetoresEstresse)
              secaoSetoresEstresse.style.display = "block";
            if (alertasContainer) alertasContainer.style.display = "block";
            if (secaoRegistrosHumor)
              secaoRegistrosHumor.style.display = "block";

            carregarRegistrosHumor();
          }

          // Mostrar bot√µes e se√ß√µes apenas para RH
          if (userRole === "RH") {
            console.log("UserRole √© RH, mostrando elementos");
            mostrarElementosRH();
          } else if (userRole === "FUNCIONARIO") {
            document.getElementById("tituloDashboard").textContent =
              "WorkWell - Bem-Estar";
          } else {
            console.warn(
              "UserRole n√£o reconhecido:",
              userRole,
              "Tipo:",
              typeof userRole
            );
          }

          const btnLogout = document.getElementById("btnLogout");
          if (btnLogout) {
            btnLogout.addEventListener("click", () => {
              localStorage.removeItem("token");
              localStorage.removeItem("userRole");
              window.location.href = "/login";
            });
          }

          // Fun√ß√£o para fazer requisi√ß√µes autenticadas
          async function apiRequest(url, options = {}) {
            const defaultOptions = {
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
            };
            const response = await fetch(url, {
              ...defaultOptions,
              ...options,
            });
            if (response.status === 401) {
              localStorage.removeItem("token");
              localStorage.removeItem("userRole");
              window.location.href = "/login";
            }
            return response;
          }

          // Carregar Dashboard
          async function carregarDashboard() {
            if (userRole !== "RH") {
              return; // Apenas RH pode ver o dashboard completo
            }

            try {
              const response = await apiRequest("/api/dashboard-rh");
              const data = await response.json();

              // Atualizar indicadores
              document.getElementById("nivelHumor").textContent =
                data.nivelMedioHumor ? data.nivelMedioHumor.toFixed(1) : "N/A";
              document.getElementById("frequenciaConsultas").textContent =
                data.frequenciaConsultas || 0;
              document.getElementById("aderenciaAtividades").textContent =
                data.aderenciaAtividades
                  ? (data.aderenciaAtividades * 100).toFixed(1) + "%"
                  : "0%";
              document.getElementById("totalSetoresEstresse").textContent =
                data.setoresComEstresse ? data.setoresComEstresse.length : 0;

              // Renderizar setores com estresse
              renderizarSetoresEstresse(data.setoresComEstresse || []);

              // Renderizar alertas
              renderizarAlertas(data.alertas || []);
            } catch (error) {
              console.error("Erro ao carregar dashboard:", error);
            }
          }

          // Renderizar setores com estresse
          function renderizarSetoresEstresse(setores) {
            const container = document.getElementById(
              "setoresEstresseContainer"
            );
            if (setores.length === 0) {
              container.innerHTML =
                "<p class='text-muted'>Nenhum setor com estresse identificado.</p>";
              return;
            }

            const html = setores
              .map(
                (setor) => `
          <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
            <div>
              <strong>${setor.setor || "Sem setor"}</strong>
              <small class="text-muted d-block">${
                setor.totalRegistros
              } registro(s)</small>
            </div>
            <div class="text-end">
              <span class="badge ${
                setor.nivelMedioHumor < 2.5
                  ? "bg-danger"
                  : setor.nivelMedioHumor < 3.5
                  ? "bg-warning"
                  : "bg-success"
              }">
                ${setor.nivelMedioHumor.toFixed(1)}/5.0
              </span>
            </div>
          </div>
        `
              )
              .join("");
            container.innerHTML = html;
          }

          // Renderizar alertas
          function renderizarAlertas(alertas) {
            const container = document.getElementById("alertasContainer");
            if (alertas.length === 0) {
              container.innerHTML = "";
              return;
            }

            const html = alertas
              .map((alerta) => {
                const severityClass =
                  {
                    ALTA: "danger",
                    MEDIA: "warning",
                    BAIXA: "info",
                  }[alerta.severidade] || "info";

                return `
            <div class="alert alert-${severityClass} alert-dismissible fade show" role="alert">
              <strong>${alerta.tipo}:</strong> ${alerta.mensagem}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          `;
              })
              .join("");
            container.innerHTML = html;
          }

          // Carregar enquetes
          async function carregarEnquetes() {
            try {
              const response = await apiRequest("/api/dashboard-rh/enquetes");
              const enquetes = await response.json();
              renderizarEnquetes(enquetes);
            } catch (error) {
              console.error("Erro ao carregar enquetes:", error);
            }
          }

          // Renderizar enquetes
          function renderizarEnquetes(enquetes) {
            const container = document.getElementById("enquetesContainer");
            if (enquetes.length === 0) {
              container.innerHTML =
                "<div class='col-12'><p class='text-muted'>Nenhuma enquete ativa no momento.</p></div>";
              return;
            }

            const html = enquetes
              .map((enquete) => {
                const jaRespondeu = enquete.jaRespondeu;
                const taxaResposta = (enquete.taxaResposta * 100).toFixed(1);

                return `
            <div class="col-md-6 col-lg-4">
              <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                  <h6 class="card-title">${enquete.pergunta}</h6>
                  ${
                    userRole === "RH"
                      ? `<p class="text-muted small mb-2">
                          ${enquete.totalRespostas} resposta(s) - ${taxaResposta}% de participa√ß√£o
                        </p>`
                      : ""
                  }
                  ${
                    jaRespondeu
                      ? '<span class="badge bg-success mb-2">Voc√™ j√° respondeu</span>'
                      : '<button class="btn btn-primary btn-sm mb-2" onclick="responderEnquete(\'' +
                        enquete.id +
                        "')\">Responder</button>"
                  }
                  ${
                    userRole === "RH" &&
                    enquete.estatisticas &&
                    enquete.estatisticas.length > 0
                      ? `
                    <div class="mt-2">
                      ${enquete.estatisticas
                        .map(
                          (e) => `
                        <small class="d-block">${e.resposta}: ${e.total}</small>
                      `
                        )
                        .join("")}
                    </div>
                  `
                      : ""
                  }
                </div>
              </div>
            </div>
          `;
              })
              .join("");
            container.innerHTML = html;
          }

          // Vari√°vel global para armazenar enquete atual
          let enqueteAtual = null;

          // Responder enquete - abre modal
          async function responderEnquete(enqueteId) {
            // Buscar dados da enquete
            try {
              const response = await apiRequest("/api/dashboard-rh/enquetes");
              const enquetes = await response.json();
              enqueteAtual = enquetes.find((e) => e.id === enqueteId);

              if (!enqueteAtual) {
                alert("Enquete n√£o encontrada");
                return;
              }

              // Preencher modal
              document.getElementById(
                "modalResponderEnquetePergunta"
              ).textContent = enqueteAtual.pergunta;

              // Limpar e preencher op√ß√µes
              const container = document.getElementById(
                "opcoesRespostaContainer"
              );
              container.innerHTML = "";

              const opcoes = enqueteAtual.opcoesResposta || [
                "SIM",
                "N√ÉO",
                "TALVEZ",
              ];
              opcoes.forEach((opcao) => {
                const div = document.createElement("div");
                div.className = "form-check mb-2";
                div.innerHTML = `
                <input class="form-check-input" type="radio" name="respostaEnquete" id="opcao_${opcao}" value="${opcao}" required>
                <label class="form-check-label" for="opcao_${opcao}">
                  ${opcao}
                </label>
              `;
                container.appendChild(div);
              });

              // Abrir modal
              const modal = new bootstrap.Modal(
                document.getElementById("modalResponderEnquete")
              );
              modal.show();
            } catch (error) {
              console.error("Erro ao carregar enquete:", error);
              alert("Erro ao carregar enquete");
            }
          }

          // Salvar resposta da enquete
          const btnSalvarRespostaEnquete = document.getElementById(
            "btnSalvarRespostaEnquete"
          );
          if (btnSalvarRespostaEnquete) {
            btnSalvarRespostaEnquete.addEventListener("click", async () => {
              if (!enqueteAtual) return;

              const respostaSelecionada = document.querySelector(
                'input[name="respostaEnquete"]:checked'
              );
              if (!respostaSelecionada) {
                alert("Por favor, selecione uma op√ß√£o");
                return;
              }

              const resposta = respostaSelecionada.value;

              try {
                const response = await apiRequest(
                  "/api/dashboard-rh/enquetes/responder",
                  {
                    method: "POST",
                    body: JSON.stringify({
                      enqueteId: enqueteAtual.id,
                      resposta: resposta,
                    }),
                  }
                );

                if (response.ok) {
                  alert("Resposta registrada com sucesso!");
                  carregarEnquetes();
                } else {
                  const error = await response.json();
                  alert(
                    "Erro: " +
                      (error.message || "N√£o foi poss√≠vel registrar a resposta")
                  );
                }
              } catch (error) {
                console.error("Erro ao responder enquete:", error);
                alert("Erro ao registrar resposta");
              }
            });
          }

          // Criar enquete
          document
            .getElementById("btnCriarEnquete")
            .addEventListener("click", () => {
              const modal = new bootstrap.Modal(
                document.getElementById("modalCriarEnquete")
              );
              modal.show();
            });

          const btnSalvarEnquete = document.getElementById("btnSalvarEnquete");
          if (btnSalvarEnquete) {
            btnSalvarEnquete.addEventListener("click", async () => {
              const pergunta = document.getElementById("enquetePergunta").value;
              const dataFim = document.getElementById("enqueteDataFim").value;

              if (!pergunta) {
                alert("Por favor, preencha a pergunta");
                return;
              }

              // Coletar op√ß√µes
              const opcoesInputs = document.querySelectorAll(
                "#opcoesContainer .opcao-input"
              );
              const opcoes = Array.from(opcoesInputs)
                .map((input) => input.value.trim())
                .filter((opcao) => opcao.length > 0);

              if (opcoes.length < 2) {
                alert("Por favor, adicione pelo menos 2 op√ß√µes de resposta");
                return;
              }

              try {
                const body = {
                  pergunta: pergunta,
                  opcoesResposta: opcoes,
                  dataFim: dataFim ? new Date(dataFim).toISOString() : null,
                };

                const response = await apiRequest(
                  "/api/dashboard-rh/enquetes",
                  {
                    method: "POST",
                    body: JSON.stringify(body),
                  }
                );

                if (response.ok) {
                  alert("Enquete criada com sucesso!");
                  bootstrap.Modal.getInstance(
                    document.getElementById("modalCriarEnquete")
                  ).hide();
                  document.getElementById("formCriarEnquete").reset();
                  // Resetar op√ß√µes para padr√£o
                  const opcoesContainer =
                    document.getElementById("opcoesContainer");
                  opcoesContainer.innerHTML = `
                  <div class="input-group mb-2">
                    <input type="text" class="form-control opcao-input" placeholder="Ex: BOM" />
                    <button type="button" class="btn btn-outline-danger" onclick="removerOpcao(this)">Remover</button>
                  </div>
                  <div class="input-group mb-2">
                    <input type="text" class="form-control opcao-input" placeholder="Ex: RUIM" />
                    <button type="button" class="btn btn-outline-danger" onclick="removerOpcao(this)">Remover</button>
                  </div>
                  <div class="input-group mb-2">
                    <input type="text" class="form-control opcao-input" placeholder="Ex: N√ÉO VI AINDA" />
                    <button type="button" class="btn btn-outline-danger" onclick="removerOpcao(this)">Remover</button>
                  </div>
                `;
                  carregarEnquetes();
                  if (userRole === "RH") {
                    carregarDashboard();
                  }
                } else {
                  const errorData = await response
                    .json()
                    .catch(() => ({ message: "Erro desconhecido" }));
                  const errorMessage =
                    errorData.message ||
                    errorData.details?.[0] ||
                    "N√£o foi poss√≠vel criar a enquete";
                  alert("Erro: " + errorMessage);
                  console.error("Erro ao criar enquete:", errorData);
                }
              } catch (error) {
                console.error("Erro ao criar enquete:", error);
                alert("Erro ao criar enquete: " + error.message);
              }
            });
          }

          // Carregar atividades
          async function carregarAtividades() {
            try {
              const response = await apiRequest("/api/dashboard-rh/atividades");
              const atividades = await response.json();
              renderizarAtividades(atividades);
            } catch (error) {
              console.error("Erro ao carregar atividades:", error);
            }
          }

          // Renderizar atividades
          function renderizarAtividades(atividades) {
            const container = document.getElementById("atividadesContainer");
            if (atividades.length === 0) {
              container.innerHTML =
                "<div class='col-12'><p class='text-muted'>Nenhuma atividade cadastrada.</p></div>";
              return;
            }

            const tipoLabels = {
              ATIVIDADE_FISICA: "Atividade F√≠sica",
              HAPPY_HOUR: "Happy Hour",
              PALESTRA_BEM_ESTAR: "Palestra de Bem-Estar",
              MEDITACAO_GUIADA: "Medita√ß√£o Guiada",
              INTERACAO_SOCIAL: "Intera√ß√£o Social",
              SESSAO_ANTI_BURNOUT: "Sess√£o Anti-Burnout",
            };

            const html = atividades
              .map((atividade) => {
                const jaParticipou = atividade.jaParticipou;
                const taxaParticipacao = (
                  atividade.taxaParticipacao * 100
                ).toFixed(1);
                const dataInicio = new Date(
                  atividade.dataHoraInicio
                ).toLocaleString("pt-BR");

                return `
            <div class="col-md-6 col-lg-4">
              <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                  <span class="badge bg-secondary mb-2">${
                    tipoLabels[atividade.tipo] || atividade.tipo
                  }</span>
                  <h6 class="card-title">${atividade.titulo}</h6>
                  ${
                    atividade.descricao
                      ? `<p class="text-muted small">${atividade.descricao}</p>`
                      : ""
                  }
                  <p class="small mb-2">
                    <strong>Data:</strong> ${dataInicio}<br>
                    ${
                      atividade.local
                        ? `<strong>Local:</strong> ${atividade.local}`
                        : ""
                    }
                  </p>
                  ${
                    userRole === "RH"
                      ? `<p class="text-muted small mb-2">
                          ${atividade.totalParticipantes} participante(s) - ${taxaParticipacao}% de ader√™ncia
                        </p>`
                      : ""
                  }
                  ${
                    userRole === "RH"
                      ? `<button class="btn btn-info btn-sm mb-2" onclick="verParticipantes('${
                          atividade.id
                        }')">Ver Participantes (${
                          atividade.totalParticipantes || 0
                        })</button><br>`
                      : ""
                  }
                  ${
                    jaParticipou
                      ? atividade.vaiParticipar === true
                        ? '<span class="badge bg-success me-2">Vou participar</span><button class="btn btn-outline-danger btn-sm" onclick="participarAtividade(\'' +
                          atividade.id +
                          "', false)\">N√£o vou</button>"
                        : atividade.vaiParticipar === false
                        ? '<span class="badge bg-danger me-2">N√£o vou participar</span><button class="btn btn-outline-success btn-sm" onclick="participarAtividade(\'' +
                          atividade.id +
                          "', true)\">Vou</button>"
                        : '<span class="badge bg-secondary">Registrado</span>'
                      : '<div class="d-flex gap-2"><button class="btn btn-success btn-sm" onclick="participarAtividade(\'' +
                        atividade.id +
                        '\', true)">Vou</button><button class="btn btn-danger btn-sm" onclick="participarAtividade(\'' +
                        atividade.id +
                        "', false)\">N√£o vou</button></div>"
                  }
                </div>
              </div>
            </div>
          `;
              })
              .join("");
            container.innerHTML = html;
          }

          // Participar atividade
          async function participarAtividade(atividadeId, vaiParticipar) {
            try {
              const response = await apiRequest(
                "/api/dashboard-rh/atividades/participar",
                {
                  method: "POST",
                  body: JSON.stringify({
                    atividadeId: atividadeId,
                    vaiParticipar: vaiParticipar,
                  }),
                }
              );

              if (response.ok) {
                const mensagem = vaiParticipar
                  ? "Voc√™ confirmou que vai participar!"
                  : "Voc√™ informou que n√£o vai participar.";
                alert(mensagem);
                carregarAtividades();
                if (userRole === "RH") {
                  carregarDashboard();
                }
              } else {
                const error = await response.json();
                alert(
                  "Erro: " +
                    (error.message ||
                      "N√£o foi poss√≠vel registrar a participa√ß√£o")
                );
              }
            } catch (error) {
              console.error("Erro ao participar atividade:", error);
              alert("Erro ao registrar participa√ß√£o");
            }
          }

          // Criar atividade
          const btnCriarAtividade =
            document.getElementById("btnCriarAtividade");
          if (btnCriarAtividade) {
            btnCriarAtividade.addEventListener("click", () => {
              const modal = new bootstrap.Modal(
                document.getElementById("modalCriarAtividade")
              );
              modal.show();
            });
          }

          const btnSalvarAtividade =
            document.getElementById("btnSalvarAtividade");
          if (btnSalvarAtividade) {
            btnSalvarAtividade.addEventListener("click", async () => {
              const tipo = document.getElementById("atividadeTipo").value;
              const titulo = document.getElementById("atividadeTitulo").value;
              const descricao =
                document.getElementById("atividadeDescricao").value;
              const dataInicio = document.getElementById(
                "atividadeDataInicio"
              ).value;
              const dataFim = document.getElementById("atividadeDataFim").value;
              const local = document.getElementById("atividadeLocal").value;

              if (!tipo || !titulo || !dataInicio) {
                alert("Por favor, preencha os campos obrigat√≥rios");
                return;
              }

              try {
                const body = {
                  tipo: tipo,
                  titulo: titulo,
                  descricao: descricao || null,
                  dataHoraInicio: new Date(dataInicio).toISOString(),
                  dataHoraFim: dataFim ? new Date(dataFim).toISOString() : null,
                  local: local || null,
                };

                const response = await apiRequest(
                  "/api/dashboard-rh/atividades",
                  {
                    method: "POST",
                    body: JSON.stringify(body),
                  }
                );

                if (response.ok) {
                  alert("Atividade criada com sucesso!");
                  bootstrap.Modal.getInstance(
                    document.getElementById("modalCriarAtividade")
                  ).hide();
                  document.getElementById("formCriarAtividade").reset();
                  carregarAtividades();
                  if (userRole === "RH") {
                    carregarDashboard();
                  }
                } else {
                  const errorData = await response
                    .json()
                    .catch(() => ({ message: "Erro desconhecido" }));
                  const errorMessage =
                    errorData.message ||
                    errorData.details?.[0] ||
                    "N√£o foi poss√≠vel criar a atividade";
                  alert("Erro: " + errorMessage);
                  console.error("Erro ao criar atividade:", errorData);
                }
              } catch (error) {
                console.error("Erro ao criar atividade:", error);
                alert("Erro ao criar atividade: " + error.message);
              }
            });
          }

          // Registrar humor
          const humorNivel = document.getElementById("humorNivel");
          if (humorNivel) {
            humorNivel.addEventListener("input", (e) => {
              const humorNivelDisplay =
                document.getElementById("humorNivelDisplay");
              if (humorNivelDisplay) {
                humorNivelDisplay.textContent = e.target.value;
              }
            });
          }

          const btnSalvarHumor = document.getElementById("btnSalvarHumor");
          if (btnSalvarHumor) {
            btnSalvarHumor.addEventListener("click", async () => {
              const nivel = parseInt(
                document.getElementById("humorNivel").value
              );
              const setor = document.getElementById("humorSetor").value;
              const observacoes =
                document.getElementById("humorObservacoes").value;

              try {
                const response = await apiRequest("/api/dashboard-rh/humor", {
                  method: "POST",
                  body: JSON.stringify({
                    nivelHumor: nivel,
                    setor: setor || null,
                    observacoes: observacoes || null,
                  }),
                });

                if (response.ok) {
                  alert("Humor registrado com sucesso!");
                  bootstrap.Modal.getInstance(
                    document.getElementById("modalRegistrarHumor")
                  ).hide();
                  document.getElementById("formRegistrarHumor").reset();
                  document.getElementById("humorNivelDisplay").textContent =
                    "3";
                  if (userRole === "RH") {
                    carregarDashboard();
                    carregarRegistrosHumor();
                  }
                } else {
                  const error = await response.json();
                  alert(
                    "Erro: " +
                      (error.message || "N√£o foi poss√≠vel registrar o humor")
                  );
                }
              } catch (error) {
                console.error("Erro ao registrar humor:", error);
                alert("Erro ao registrar humor");
              }
            });
          }

          // Bot√£o para registrar humor (vis√≠vel para todos)
          const btnRegistrarHumor = document.createElement("button");
          btnRegistrarHumor.className = "btn btn-primary btn-sm";
          btnRegistrarHumor.textContent = "Registrar Humor";
          btnRegistrarHumor.onclick = () => {
            const modal = new bootstrap.Modal(
              document.getElementById("modalRegistrarHumor")
            );
            modal.show();
          };
          const headerContainer = document.querySelector("header .d-flex");
          if (headerContainer) {
            headerContainer.appendChild(btnRegistrarHumor);
          }

          // Carregar registros de humor (apenas RH)
          async function carregarRegistrosHumor() {
            if (userRole !== "RH") return;

            try {
              const response = await apiRequest(
                "/api/dashboard-rh/humor/registros"
              );
              const registros = await response.json();
              renderizarRegistrosHumor(registros);
            } catch (error) {
              console.error("Erro ao carregar registros de humor:", error);
            }
          }

          // Renderizar registros de humor
          function renderizarRegistrosHumor(registros) {
            const container = document.getElementById(
              "registrosHumorContainer"
            );
            if (registros.length === 0) {
              container.innerHTML =
                "<p class='text-muted'>Nenhum registro de humor encontrado.</p>";
              return;
            }

            const html = registros
              .map((registro) => {
                const dataRegistro = new Date(
                  registro.createdAt
                ).toLocaleString("pt-BR");
                const nivelClass =
                  registro.nivelHumor < 2.5
                    ? "danger"
                    : registro.nivelHumor < 3.5
                    ? "warning"
                    : "success";

                return `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
              <div>
                <strong>${registro.nomeUsuario}</strong>
                <small class="text-muted d-block">${dataRegistro}</small>
                ${
                  registro.setor
                    ? `<small class="text-muted">Setor: ${registro.setor}</small>`
                    : ""
                }
                ${
                  registro.observacoes
                    ? `<p class="small mb-0 mt-1">${registro.observacoes}</p>`
                    : ""
                }
              </div>
              <div class="text-end">
                <span class="badge bg-${nivelClass}">${
                  registro.nivelHumor
                }/5</span>
              </div>
            </div>
          `;
              })
              .join("");
            container.innerHTML = html;
          }

          // Ver participantes de atividade
          async function verParticipantes(atividadeId) {
            try {
              const response = await apiRequest(
                `/api/dashboard-rh/atividades/${atividadeId}/participantes`
              );
              const participantes = await response.json();

              if (participantes.length === 0) {
                alert("Nenhum participante ainda.");
                return;
              }

              const lista = participantes
                .map((p) => `‚Ä¢ ${p.nomeUsuario} (${p.emailUsuario})`)
                .join("\n");
              alert(`Participantes:\n\n${lista}`);
            } catch (error) {
              console.error("Erro ao carregar participantes:", error);
              alert("Erro ao carregar participantes");
            }
          }

          // Fun√ß√µes para gerenciar op√ß√µes ao criar enquete
          function adicionarOpcao() {
            const container = document.getElementById("opcoesContainer");
            const div = document.createElement("div");
            div.className = "input-group mb-2";
            div.innerHTML = `
            <input type="text" class="form-control opcao-input" placeholder="Ex: Nova op√ß√£o" />
            <button type="button" class="btn btn-outline-danger" onclick="removerOpcao(this)">Remover</button>
          `;
            container.appendChild(div);
          }

          function removerOpcao(btn) {
            const container = document.getElementById("opcoesContainer");
            if (container.children.length > 1) {
              btn.closest(".input-group").remove();
            } else {
              alert("Voc√™ precisa ter pelo menos uma op√ß√£o");
            }
          }

          // ========== AVALIA√á√ïES PROFUNDAS ==========
          let avaliacaoAtual = null;

          // Mostrar/ocultar bot√µes baseado no role
          if (userRole === "PSICOLOGO") {
            const btnCriar = document.getElementById(
              "btnCriarAvaliacaoProfunda"
            );
            if (btnCriar) btnCriar.style.display = "block";
            const secaoMinhas = document.getElementById(
              "secaoMinhasAvaliacoes"
            );
            if (secaoMinhas) secaoMinhas.style.display = "block";
          }

          // Carregar avalia√ß√µes profundas
          async function carregarAvaliacoesProfundas() {
            try {
              const response = await apiRequest("/api/avaliacoes-profundas");
              if (response.ok) {
                const avaliacoes = await response.json();
                const container = document.getElementById(
                  "avaliacoesProfundasContainer"
                );
                if (!container) return;

                if (avaliacoes.length === 0) {
                  container.innerHTML = `
                    <div class="col-12">
                      <div class="alert alert-info">
                        Nenhuma avalia√ß√£o profunda dispon√≠vel no momento.
                      </div>
                    </div>
                  `;
                  return;
                }

                const html = avaliacoes
                  .map((avaliacao) => {
                    const dataInicio = new Date(
                      avaliacao.dataInicio
                    ).toLocaleString("pt-BR");
                    const dataFim = new Date(avaliacao.dataFim).toLocaleString(
                      "pt-BR"
                    );
                    const jaRespondeu = avaliacao.jaRespondeu;
                    const podeResponder =
                      !jaRespondeu && new Date(avaliacao.dataFim) >= new Date();

                    return `
                      <div class="col-md-6 col-lg-4">
                        <div class="card shadow-sm border-0 h-100">
                          <div class="card-body">
                            <h5 class="card-title">${avaliacao.titulo}</h5>
                            <p class="card-text text-muted small">${
                              avaliacao.descricao || "Sem descri√ß√£o"
                            }</p>
                            <div class="mb-2">
                              <small class="text-muted">
                                <strong>In√≠cio:</strong> ${dataInicio}<br>
                                <strong>T√©rmino:</strong> ${dataFim}
                              </small>
                            </div>
                            <div class="mb-2">
                              <small class="text-muted">
                                ${avaliacao.totalRespostas} de ${
                      avaliacao.totalUsuarios
                    } respostas
                                (${(avaliacao.taxaResposta * 100).toFixed(1)}%)
                              </small>
                            </div>
                            ${
                              userRole === "FUNCIONARIO" && podeResponder
                                ? `<button class="btn btn-primary btn-sm w-100" onclick="abrirModalResponderAvaliacao('${avaliacao.id}')">
                                  Responder Avalia√ß√£o
                                </button>`
                                : userRole === "FUNCIONARIO" && jaRespondeu
                                ? `<button class="btn btn-secondary btn-sm w-100" disabled>
                                  J√° Respondida
                                </button>`
                                : userRole === "PSICOLOGO"
                                ? `<button class="btn btn-info btn-sm w-100" onclick="verRelatorio('${avaliacao.id}')">
                                  Ver Relat√≥rio
                                </button>`
                                : ""
                            }
                          </div>
                        </div>
                      </div>
                    `;
                  })
                  .join("");
                container.innerHTML = html;
              }
            } catch (error) {
              console.error("Erro ao carregar avalia√ß√µes profundas:", error);
            }
          }

          // Carregar minhas avalia√ß√µes (psic√≥logo)
          async function carregarMinhasAvaliacoes() {
            if (userRole !== "PSICOLOGO") return;
            try {
              const response = await apiRequest(
                "/api/avaliacoes-profundas/minhas"
              );
              if (response.ok) {
                const avaliacoes = await response.json();
                const container = document.getElementById(
                  "minhasAvaliacoesContainer"
                );
                if (!container) return;

                if (avaliacoes.length === 0) {
                  container.innerHTML = `
                    <div class="col-12">
                      <div class="alert alert-info">
                        Voc√™ ainda n√£o criou nenhuma avalia√ß√£o profunda.
                      </div>
                    </div>
                  `;
                  return;
                }

                const html = avaliacoes
                  .map((avaliacao) => {
                    const dataInicio = new Date(
                      avaliacao.dataInicio
                    ).toLocaleString("pt-BR");
                    const dataFim = new Date(avaliacao.dataFim).toLocaleString(
                      "pt-BR"
                    );
                    const ativa = avaliacao.ativa ? "Ativa" : "Inativa";

                    return `
                      <div class="col-md-6 col-lg-4">
                        <div class="card shadow-sm border-0 h-100">
                          <div class="card-body">
                            <h5 class="card-title">${avaliacao.titulo}</h5>
                            <p class="card-text text-muted small">${
                              avaliacao.descricao || "Sem descri√ß√£o"
                            }</p>
                            <div class="mb-2">
                              <span class="badge ${
                                avaliacao.ativa ? "bg-success" : "bg-secondary"
                              }">${ativa}</span>
                            </div>
                            <div class="mb-2">
                              <small class="text-muted">
                                <strong>In√≠cio:</strong> ${dataInicio}<br>
                                <strong>T√©rmino:</strong> ${dataFim}
                              </small>
                            </div>
                            <div class="mb-2">
                              <small class="text-muted">
                                ${avaliacao.totalRespostas} de ${
                      avaliacao.totalUsuarios
                    } respostas
                                (${(avaliacao.taxaResposta * 100).toFixed(1)}%)
                              </small>
                            </div>
                            <button class="btn btn-info btn-sm w-100" onclick="verRelatorio('${
                              avaliacao.id
                            }')">
                              Ver Relat√≥rio Confidencial
                            </button>
                          </div>
                        </div>
                      </div>
                    `;
                  })
                  .join("");
                container.innerHTML = html;
              }
            } catch (error) {
              console.error("Erro ao carregar minhas avalia√ß√µes:", error);
            }
          }

          // Criar avalia√ß√£o profunda
          const btnCriarAvaliacaoProfunda = document.getElementById(
            "btnCriarAvaliacaoProfunda"
          );
          if (btnCriarAvaliacaoProfunda) {
            btnCriarAvaliacaoProfunda.addEventListener("click", () => {
              const modal = new bootstrap.Modal(
                document.getElementById("modalCriarAvaliacaoProfunda")
              );
              modal.show();
            });
          }

          // Salvar avalia√ß√£o profunda
          const btnSalvarAvaliacaoProfunda = document.getElementById(
            "btnSalvarAvaliacaoProfunda"
          );
          if (btnSalvarAvaliacaoProfunda) {
            btnSalvarAvaliacaoProfunda.addEventListener("click", async () => {
              const titulo = document.getElementById("avaliacaoTitulo").value;
              const descricao =
                document.getElementById("avaliacaoDescricao").value;
              const dataInicio = document.getElementById(
                "avaliacaoDataInicio"
              ).value;
              const dataFim = document.getElementById("avaliacaoDataFim").value;

              if (!titulo || !dataInicio || !dataFim) {
                alert("Por favor, preencha os campos obrigat√≥rios");
                return;
              }

              // Coletar perguntas
              const perguntasItems =
                document.querySelectorAll(".pergunta-item");
              const perguntas = [];
              let perguntaId = 1;

              for (const item of perguntasItems) {
                const texto = item.querySelector(".pergunta-texto").value;
                const tipo = item.querySelector(".pergunta-tipo").value;

                if (!texto || !tipo) {
                  alert("Por favor, preencha todas as perguntas");
                  return;
                }

                const pergunta = {
                  id: perguntaId++,
                  pergunta: texto,
                  tipo: tipo,
                };

                if (tipo === "ESCOLHA") {
                  const opcoes = Array.from(
                    item.querySelectorAll(".opcao-input")
                  )
                    .map((input) => input.value)
                    .filter((val) => val.trim() !== "");

                  if (opcoes.length < 2) {
                    alert("Perguntas de escolha devem ter pelo menos 2 op√ß√µes");
                    return;
                  }
                  pergunta.opcoes = opcoes;
                }

                perguntas.push(pergunta);
              }

              if (perguntas.length === 0) {
                alert("Adicione pelo menos uma pergunta");
                return;
              }

              try {
                const body = {
                  titulo: titulo,
                  descricao: descricao,
                  perguntas: perguntas,
                  dataInicio: dataInicio,
                  dataFim: dataFim,
                };

                const response = await apiRequest("/api/avaliacoes-profundas", {
                  method: "POST",
                  body: JSON.stringify(body),
                });

                if (response.ok) {
                  alert("Avalia√ß√£o criada com sucesso!");
                  const modal = bootstrap.Modal.getInstance(
                    document.getElementById("modalCriarAvaliacaoProfunda")
                  );
                  modal.hide();
                  document.getElementById("formCriarAvaliacaoProfunda").reset();
                  document.getElementById("perguntasContainer").innerHTML = `
                    <div class="card mb-3 pergunta-item">
                      <div class="card-body">
                        <div class="row mb-2">
                          <div class="col-md-8">
                            <input type="text" class="form-control pergunta-texto" placeholder="Digite a pergunta..." required />
                          </div>
                          <div class="col-md-4">
                            <select class="form-select pergunta-tipo" required>
                              <option value="TEXTO">Texto Livre</option>
                              <option value="NUMERICO">Num√©rico (1-10)</option>
                              <option value="ESCOLHA">Escolha √önica</option>
                            </select>
                          </div>
                        </div>
                        <div class="opcoes-escolha" style="display: none">
                          <label class="form-label small">Op√ß√µes de Resposta</label>
                          <div class="opcoes-container">
                            <div class="input-group mb-2">
                              <input type="text" class="form-control opcao-input" placeholder="Op√ß√£o 1" />
                              <button type="button" class="btn btn-outline-danger btn-sm" onclick="removerOpcaoEscolha(this)">Remover</button>
                            </div>
                          </div>
                          <button type="button" class="btn btn-sm btn-outline-primary" onclick="adicionarOpcaoEscolha(this)">+ Adicionar Op√ß√£o</button>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="removerPergunta(this)">Remover Pergunta</button>
                      </div>
                    </div>
                  `;
                  carregarAvaliacoesProfundas();
                  carregarMinhasAvaliacoes();
                } else {
                  const error = await response.json();
                  alert(
                    "Erro: " +
                      (error.message || "N√£o foi poss√≠vel criar a avalia√ß√£o")
                  );
                }
              } catch (error) {
                console.error("Erro ao criar avalia√ß√£o:", error);
                alert("Erro ao criar avalia√ß√£o");
              }
            });
          }

          // Abrir modal para responder avalia√ß√£o
          window.abrirModalResponderAvaliacao = async function (avaliacaoId) {
            try {
              const response = await apiRequest("/api/avaliacoes-profundas");
              if (response.ok) {
                const avaliacoes = await response.json();
                const avaliacao = avaliacoes.find((a) => a.id === avaliacaoId);

                if (!avaliacao) {
                  alert("Avalia√ß√£o n√£o encontrada");
                  return;
                }

                avaliacaoAtual = avaliacao;
                document.getElementById(
                  "modalResponderAvaliacaoTitulo"
                ).textContent = avaliacao.titulo;
                document.getElementById(
                  "modalResponderAvaliacaoDescricao"
                ).textContent = avaliacao.descricao || "";

                // Criar campos de resposta
                const container = document.getElementById("respostasContainer");
                container.innerHTML = avaliacao.perguntas
                  .map((pergunta, index) => {
                    let inputHtml = "";

                    if (pergunta.tipo === "TEXTO") {
                      inputHtml = `<textarea class="form-control" id="resposta_${pergunta.id}" rows="3" required></textarea>`;
                    } else if (pergunta.tipo === "NUMERICO") {
                      inputHtml = `<input type="number" class="form-control" id="resposta_${pergunta.id}" min="1" max="10" required />`;
                    } else if (pergunta.tipo === "ESCOLHA") {
                      const opcoes = pergunta.opcoes || [];
                      inputHtml = `<select class="form-select" id="resposta_${
                        pergunta.id
                      }" required>
                      <option value="">Selecione...</option>
                      ${opcoes
                        .map((op) => `<option value="${op}">${op}</option>`)
                        .join("")}
                    </select>`;
                    }

                    return `
                    <div class="mb-3">
                      <label class="form-label"><strong>${pergunta.pergunta}</strong></label>
                      ${inputHtml}
                    </div>
                  `;
                  })
                  .join("");

                const modal = new bootstrap.Modal(
                  document.getElementById("modalResponderAvaliacaoProfunda")
                );
                modal.show();
              }
            } catch (error) {
              console.error("Erro ao abrir modal de resposta:", error);
              alert("Erro ao carregar avalia√ß√£o");
            }
          };

          // Salvar resposta da avalia√ß√£o
          const btnSalvarRespostaAvaliacaoProfunda = document.getElementById(
            "btnSalvarRespostaAvaliacaoProfunda"
          );
          if (btnSalvarRespostaAvaliacaoProfunda) {
            btnSalvarRespostaAvaliacaoProfunda.addEventListener(
              "click",
              async () => {
                if (!avaliacaoAtual) return;

                const respostas = {};
                avaliacaoAtual.perguntas.forEach((pergunta) => {
                  const input = document.getElementById(
                    `resposta_${pergunta.id}`
                  );
                  if (input) {
                    respostas[pergunta.id] = input.value;
                  }
                });

                const observacoes = document.getElementById(
                  "avaliacaoObservacoes"
                ).value;

                try {
                  const body = {
                    avaliacaoId: avaliacaoAtual.id,
                    respostas: respostas,
                    observacoes: observacoes,
                  };

                  const response = await apiRequest(
                    "/api/avaliacoes-profundas/responder",
                    {
                      method: "POST",
                      body: JSON.stringify(body),
                    }
                  );

                  if (response.ok) {
                    alert("Respostas enviadas com sucesso!");
                    const modal = bootstrap.Modal.getInstance(
                      document.getElementById("modalResponderAvaliacaoProfunda")
                    );
                    modal.hide();
                    carregarAvaliacoesProfundas();
                  } else {
                    const error = await response.json();
                    alert(
                      "Erro: " +
                        (error.message ||
                          "N√£o foi poss√≠vel enviar as respostas")
                    );
                  }
                } catch (error) {
                  console.error("Erro ao enviar respostas:", error);
                  alert("Erro ao enviar respostas");
                }
              }
            );
          }

          // Ver relat√≥rio
          window.verRelatorio = async function (avaliacaoId) {
            try {
              const response = await apiRequest(
                `/api/avaliacoes-profundas/${avaliacaoId}/relatorio`
              );
              if (response.ok) {
                const relatorio = await response.json();
                document.getElementById(
                  "modalRelatorioTitulo"
                ).textContent = `Relat√≥rio: ${relatorio.titulo}`;

                const container = document.getElementById("relatorioContainer");
                container.innerHTML = `
                  <div class="mb-4">
                    <h6>Informa√ß√µes Gerais</h6>
                    <p class="text-muted">${
                      relatorio.descricao || "Sem descri√ß√£o"
                    }</p>
                    <p><strong>Per√≠odo:</strong> ${new Date(
                      relatorio.dataInicio
                    ).toLocaleString("pt-BR")} at√© ${new Date(
                  relatorio.dataFim
                ).toLocaleString("pt-BR")}</p>
                    <p><strong>Total de Respostas:</strong> ${
                      relatorio.totalRespostas
                    } de ${relatorio.totalUsuarios} funcion√°rios (${(
                  relatorio.taxaResposta * 100
                ).toFixed(1)}%)</p>
                  </div>
                  
                  <div class="mb-4">
                    <h6>Respostas Detalhadas</h6>
                    <div class="table-responsive">
                      <table class="table table-striped">
                        <thead>
                          <tr>
                            <th>Funcion√°rio</th>
                            <th>Email</th>
                            <th>Respostas</th>
                            <th>Observa√ß√µes</th>
                            <th>Data</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${relatorio.respostasDetalhadas
                            .map(
                              (r) => `
                            <tr>
                              <td>${r.nomeUsuario}</td>
                              <td>${r.emailUsuario}</td>
                              <td><pre class="small">${JSON.stringify(
                                r.respostas,
                                null,
                                2
                              )}</pre></td>
                              <td>${r.observacoes || "-"}</td>
                              <td>${new Date(r.createdAt).toLocaleString(
                                "pt-BR"
                              )}</td>
                            </tr>
                          `
                            )
                            .join("")}
                        </tbody>
                      </table>
                    </div>
                  </div>
                  
                  ${
                    relatorio.analiseEstatistica
                      ? `
                    <div class="mb-4">
                      <h6>An√°lise Estat√≠stica</h6>
                      <pre class="bg-light p-3 rounded">${JSON.stringify(
                        relatorio.analiseEstatistica,
                        null,
                        2
                      )}</pre>
                    </div>
                  `
                      : ""
                  }
                `;

                const modal = new bootstrap.Modal(
                  document.getElementById("modalVerRelatorio")
                );
                modal.show();
              } else {
                const error = await response.json();
                alert(
                  "Erro: " +
                    (error.message || "N√£o foi poss√≠vel carregar o relat√≥rio")
                );
              }
            } catch (error) {
              console.error("Erro ao carregar relat√≥rio:", error);
              alert("Erro ao carregar relat√≥rio");
            }
          };

          // Fun√ß√µes auxiliares para gerenciar perguntas
          window.adicionarPergunta = function () {
            const container = document.getElementById("perguntasContainer");
            const div = document.createElement("div");
            div.className = "card mb-3 pergunta-item";
            div.innerHTML = `
              <div class="card-body">
                <div class="row mb-2">
                  <div class="col-md-8">
                    <input type="text" class="form-control pergunta-texto" placeholder="Digite a pergunta..." required />
                  </div>
                  <div class="col-md-4">
                    <select class="form-select pergunta-tipo" required onchange="toggleOpcoesEscolha(this)">
                      <option value="TEXTO">Texto Livre</option>
                      <option value="NUMERICO">Num√©rico (1-10)</option>
                      <option value="ESCOLHA">Escolha √önica</option>
                    </select>
                  </div>
                </div>
                <div class="opcoes-escolha" style="display: none">
                  <label class="form-label small">Op√ß√µes de Resposta</label>
                  <div class="opcoes-container">
                    <div class="input-group mb-2">
                      <input type="text" class="form-control opcao-input" placeholder="Op√ß√£o 1" />
                      <button type="button" class="btn btn-outline-danger btn-sm" onclick="removerOpcaoEscolha(this)">Remover</button>
                    </div>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-primary" onclick="adicionarOpcaoEscolha(this)">+ Adicionar Op√ß√£o</button>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="removerPergunta(this)">Remover Pergunta</button>
              </div>
            `;
            container.appendChild(div);
          };

          window.removerPergunta = function (btn) {
            const container = document.getElementById("perguntasContainer");
            if (container.children.length > 1) {
              btn.closest(".pergunta-item").remove();
            } else {
              alert("Voc√™ precisa ter pelo menos uma pergunta");
            }
          };

          window.toggleOpcoesEscolha = function (select) {
            const item = select.closest(".pergunta-item");
            const opcoesDiv = item.querySelector(".opcoes-escolha");
            if (select.value === "ESCOLHA") {
              opcoesDiv.style.display = "block";
            } else {
              opcoesDiv.style.display = "none";
            }
          };

          window.adicionarOpcaoEscolha = function (btn) {
            const container = btn.previousElementSibling;
            const div = document.createElement("div");
            div.className = "input-group mb-2";
            div.innerHTML = `
              <input type="text" class="form-control opcao-input" placeholder="Nova op√ß√£o" />
              <button type="button" class="btn btn-outline-danger btn-sm" onclick="removerOpcaoEscolha(this)">Remover</button>
            `;
            container.appendChild(div);
          };

          window.removerOpcaoEscolha = function (btn) {
            const container = btn.closest(".opcoes-container");
            if (container.children.length > 1) {
              btn.closest(".input-group").remove();
            } else {
              alert("Voc√™ precisa ter pelo menos uma op√ß√£o");
            }
          };

          // Expor fun√ß√µes no escopo global para uso em onclick
          window.responderEnquete = responderEnquete;
          window.participarAtividade = participarAtividade;
          window.verParticipantes = verParticipantes;
          window.adicionarOpcao = adicionarOpcao;
          window.removerOpcao = removerOpcao;

          // Carregar dados iniciais
          if (userRole === "RH") {
            carregarDashboard();
          }
          // Sempre carregar enquetes e atividades para RH e FUNCIONARIO
          carregarEnquetes();
          carregarAtividades();
          carregarAvaliacoesProfundas();
          if (userRole === "PSICOLOGO") {
            carregarMinhasAvaliacoes();
          }
        } catch (error) {
          console.error("Erro ao inicializar dashboard RH:", error);
          alert(
            "Erro ao carregar o dashboard. Verifique o console para mais detalhes."
          );
        }

        // Atualizar a cada 30 segundos (fora do try-catch para evitar erros)
        setInterval(() => {
          try {
            if (userRole === "RH") {
              carregarDashboard();
              carregarRegistrosHumor();
            }
            carregarEnquetes();
            carregarAtividades();
            carregarAvaliacoesProfundas();
            if (userRole === "PSICOLOGO") {
              carregarMinhasAvaliacoes();
            }
          } catch (error) {
            console.error("Erro ao atualizar dados:", error);
          }
        }, 30000);
      })(); // Fechar fun√ß√£o async auto-execut√°vel
      // ========== FUN√á√ïES DE INTELIG√äNCIA ARTIFICIAL ==========

      // Abrir Chat IA
      window.abrirChatIA = function () {
        const modal = new bootstrap.Modal(
          document.getElementById("modalChatIA")
        );
        modal.show();
        document
          .getElementById("chatInput")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              enviarMensagemChat();
            }
          });
      };

      // Enviar mensagem no chat
      window.enviarMensagemChat = async function () {
        const input = document.getElementById("chatInput");
        const mensagem = input.value.trim();
        if (!mensagem) return;

        const chatMessages = document.getElementById("chatMessages");

        // Adicionar mensagem do usu√°rio
        chatMessages.innerHTML += `
          <div class="alert alert-primary mb-2">
            <strong>Voc√™:</strong> ${mensagem}
          </div>
        `;
        input.value = "";

        // Mostrar loading
        chatMessages.innerHTML += `
          <div class="alert alert-secondary mb-2">
            <strong>Assistente:</strong> Pensando...
          </div>
        `;
        chatMessages.scrollTop = chatMessages.scrollHeight;

        try {
          const response = await apiRequest("/api/ai/chat", {
            method: "POST",
            body: JSON.stringify({
              mensagem: mensagem,
              contexto: `Usu√°rio: RH`,
            }),
          });

          if (response.ok) {
            const data = await response.json();
            // Remover loading
            chatMessages.removeChild(chatMessages.lastChild);
            // Adicionar resposta
            chatMessages.innerHTML += `
              <div class="alert alert-info mb-2">
                <strong>Assistente:</strong> ${data.resposta}
              </div>
            `;
          } else {
            throw new Error("Erro na resposta");
          }
        } catch (error) {
          chatMessages.removeChild(chatMessages.lastChild);
          chatMessages.innerHTML += `
            <div class="alert alert-danger mb-2">
              <strong>Erro:</strong> N√£o foi poss√≠vel processar sua mensagem. Tente novamente.
            </div>
          `;
        }
        chatMessages.scrollTop = chatMessages.scrollHeight;
      };

      // Abrir An√°lise de Sentimentos
      window.abrirAnaliseSentimento = function () {
        const modal = new bootstrap.Modal(
          document.getElementById("modalAnaliseSentimento")
        );
        modal.show();
        document.getElementById("resultadoAnalise").style.display = "none";
      };

      // Processar An√°lise de Sentimentos
      window.processarAnaliseSentimento = async function () {
        const texto = document.getElementById("analiseTexto").value;
        const nivelHumor = document.getElementById("analiseNivelHumor").value;
        const setor = document.getElementById("analiseSetor").value;

        if (!texto && !nivelHumor) {
          alert("Preencha pelo menos o texto ou o n√≠vel de humor");
          return;
        }

        const resultadoDiv = document.getElementById("resultadoAnalise");
        const conteudoDiv = document.getElementById("analiseConteudo");
        conteudoDiv.innerHTML =
          '<div class="spinner-border" role="status"><span class="visually-hidden">Carregando...</span></div>';

        try {
          const response = await apiRequest("/api/ai/analise-sentimento", {
            method: "POST",
            body: JSON.stringify({
              texto: texto || "",
              nivelHumor: nivelHumor ? parseInt(nivelHumor) : null,
              setor: setor || "",
            }),
          });

          if (response.ok) {
            const data = await response.json();
            const sentimentoBadge =
              data.sentimento === "positivo"
                ? "success"
                : data.sentimento === "negativo"
                ? "danger"
                : "warning";

            conteudoDiv.innerHTML = `
              <div class="mb-3">
                <span class="badge bg-${sentimentoBadge}">${data.sentimento.toUpperCase()}</span>
                <span class="ms-2">Score: ${(data.score * 100).toFixed(
                  1
                )}%</span>
              </div>
              <div class="mb-3">
                <strong>Resumo:</strong>
                <p>${data.resumo}</p>
              </div>
              <div class="mb-3">
                <strong>Pontos Chave:</strong>
                <ul>
                  ${data.pontosChave.map((p) => `<li>${p}</li>`).join("")}
                </ul>
              </div>
              <div>
                <strong>Recomenda√ß√µes:</strong>
                <ul>
                  ${data.recomendacoes.map((r) => `<li>${r}</li>`).join("")}
                </ul>
              </div>
            `;
            resultadoDiv.style.display = "block";
          } else {
            throw new Error("Erro na an√°lise");
          }
        } catch (error) {
          conteudoDiv.innerHTML = `
            <div class="alert alert-danger">
              Erro ao processar an√°lise. Tente novamente.
            </div>
          `;
        }
      };

      // Abrir Insights RH
      window.abrirInsightsRH = async function () {
        const modal = new bootstrap.Modal(
          document.getElementById("modalInsightsRH")
        );
        modal.show();

        const spinner = document.getElementById("insightsSpinner");
        const resultado = document.getElementById("resultadoInsights");
        const conteudo = document.getElementById("insightsConteudo");

        spinner.style.display = "block";
        resultado.style.display = "none";

        try {
          const response = await apiRequest("/api/dashboard-rh/insights-ai", {
            method: "POST",
          });

          if (response.ok) {
            const data = await response.json();
            spinner.style.display = "none";

            const tendenciaBadge =
              data.tendencia === "melhorando"
                ? "success"
                : data.tendencia === "preocupante"
                ? "danger"
                : "warning";

            conteudo.innerHTML = `
              <div class="mb-4">
                <h6 class="fw-bold">Resumo Executivo</h6>
                <p>${data.resumoExecutivo}</p>
              </div>
              <div class="row mb-4">
                <div class="col-md-6">
                  <h6 class="fw-bold text-success">Pontos Positivos</h6>
                  <ul>
                    ${data.pontosPositivos.map((p) => `<li>${p}</li>`).join("")}
                  </ul>
                </div>
                <div class="col-md-6">
                  <h6 class="fw-bold text-danger">Pontos Cr√≠ticos</h6>
                  <ul>
                    ${data.pontosCriticos.map((p) => `<li>${p}</li>`).join("")}
                  </ul>
                </div>
              </div>
              <div class="mb-4">
                <h6 class="fw-bold">Recomenda√ß√µes</h6>
                <ul>
                  ${data.recomendacoes.map((r) => `<li>${r}</li>`).join("")}
                </ul>
              </div>
              <div>
                <span class="badge bg-${tendenciaBadge}">Tend√™ncia: ${
              data.tendencia
            }</span>
              </div>
            `;
            resultado.style.display = "block";
          } else {
            throw new Error("Erro nos insights");
          }
        } catch (error) {
          spinner.style.display = "none";
          conteudo.innerHTML = `
            <div class="alert alert-danger">
              Erro ao gerar insights. Tente novamente.
            </div>
          `;
          resultado.style.display = "block";
        }
      };
    </script>
  </body>
</html>
